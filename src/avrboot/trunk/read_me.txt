
        BOOTLOADER ATMEGA128 для ZX Evolution

------------------------------------------------------------------------------

Использование
~~~~~~~~~~~~~
Микросхему ATMEGA128 запрограммировать файлом
ZXEVO_BL.HEX (напр. с помощью AVREAL)
или
ZXEVO_BL.E2P (с помощью PonyProg2000).

Командная строка для AVREAL (ByteBlaster на порту LPT1):
avreal32.exe -ab -p1 +ATMEGA128 -e -w zxevo_bl.hex -f_low=3F,_high=88,_ext=FF,_lock=EF -v

Командная строка для утилиты JTAGICE из комплекта AVRStudio4 (JTAGICE на порту COM1):
jtagice.exe -cCOM1 -B115200 -dATMEGA128 -e -ifzxevo_bl.hex -pf -vf -f883F -F883F -EFF -GFF -lEF -LEF

Командная строка для утилиты STK500 из комплекта AVRStudio4 (AVRISPmkII на USB-порту):
stk500.exe -cUSB -I250000 -dATMEGA128 -e -ifzxevo_bl.hex -pf -vf -f883F -F883F -EFF -GFF -lEF -LEF

В файле E2P нужные fuse биты уже установлены, просто откройте файл в PonyProg2000,
выполните стирание (Ctrl+E), запись (Ctrl+W) и запись битов (Ctrl+S).

Методика загрузки(обновления) основной прошивки
(файл avr\current\default\ZXEVO_FW.BIN)
описана в документе docs\ZXEvo_firmware_update.odt .


------------------------------------------------------------------------------

FPGA\
fpga.qpf        - проект (Quartus v6.1)
fpga.qws
main.dpf
main.qsf
main.v          - главный исходник
main.rbf        - выходной файл

AVR\
boot_evo.asm    - главный исходник
_macros.asm
evotitle.ans    - ANSI-заставка
m128def.inc
version.txt     - название прошивки (до 12 симв.)

clean.bat
make.bat        - командный файл для
                  компиляции AVR части и
                  сборки проекта.

zxevo_bl.hex    - собранный проект
zxevo_bl.e2p    - собранный проект (для PonyProg2000)


Сборка проекта
~~~~~~~~~~~~~~
1. Компилируем в Quartus-е FPGA часть проекта (получаем файл main.rbf).
2. Запускаем MAKE.BAT (компилируем AVR часть и собираем проёкт).

При сборке используются следующие программы:
tools\mhmt\mhmt.exe
tools\bin2avr\bin2avr.exe
tools\avra\avra.exe
tools\crcbldr\crcbldr.exe


------------------------------------------------------------------------------

INFO
~~~~

- CRC -

Boot-блок и основная прошивка защищены CRC-16 (CCITT).
Вычисление и запись в прошивку автоматизировано с помощью доп.утилит.
Значения кладутся в последние два байта
для boot-блока $1FFFE/$1FFFF и для основной прошивки $1DFFE/$1DFFF
(старший байт первый).


- Версии -

 Версия представляет собой идентификатор прошивки, которая располагается
в последних адресах boot-блока ($1FFF0-$1FFFD)
и основной прошивки ($1DFF0-$1DFFD).

Состав идентификатора следующий:

 +00..+11 - произвольная символьная строка, добитая до длины 12 байт нулями
 +12..+13 - 16-битная величина (младший байт первый),
            обозначающая дату релиза данной версии.

Формат 16-битной величины (биты пронумерованы начиная с младшего номером ноль)

бит  15     - бит "официальности"
биты 14..09 - год даты (8...63), 6 бит
биты 08..05 - месяц даты (1..12), 4 бита
биты 04..00 - день даты (1..31), 5 бит

Запись в прошивку автоматизировано с помощью доп.утилит. Разработчику нужно
лишь заполнить(изменить) строчку в файле VERSION.TXT перед компиляцией.


- Fuse Bits -

CKOPT=0, CKSEL321=111,
CKSEL0=1, SUT10=11
Ext. Crystal/Resonator High Freq.; Start-up time: 16K CK + 64 ms

BODEN=0, BODLEVEL=0
Brown-out Detector level at 4.0 V

BOOTRST=0
Вектор сброса на boot-блок

BOOTSZ10=00
Размер boot-блока 8кб

EESAVE=1
При ChipErase стирать EEPROM

SPIEN=0
Программирование через ISP разрешено

JTAGEN=0
JTAG разрешён

OCDEN=1
On-chip Debug запрещён

M103C=1
Режим совместимости с ATMEGA103 отключен

WDTON=1
Watchdog Timer по-умолчанию запрещён

BLB1=10
Запись в область boot-блока командой SPM запрещена
