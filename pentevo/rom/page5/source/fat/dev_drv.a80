
;LAST UPDATE: 01.10.2011 savelij

SMUC		EQU 0

MASTER		EQU 0
SLAVE		EQU 0X80

DRV_A		EQU 0		;DRIVE A
DRV_B		EQU 1		;DRIVE B
DRV_C		EQU 2		;DRIVE C
DRV_D		EQU 3		;DRIVE D
SDZ		EQU 4		;SD   ZC
SDG		EQU 5		;SD   NeoGS
HDDN		EQU 6		;HDD  NEMO
HDDS		EQU 7		;HDD  SMUC

;  
TO_DRV		PUSH HL
		LD L,A
		LD A,IYL
		AND A
		LD A,L
		JR NZ,TO_DRV1
		RST 0X10
		LD A,(REG_A)
		LD DE,(REG_E)
		LD BC,(REG_C)
		LD HL,(REG_L)
		EX (SP),HL
TO_DRV1		LD HL,(GO_DEV)
		EX (SP),HL
		RET

;   
COM_DEV		EX AF,AF'
		RST 0X10
		LD A,(NEXTBYTERST8)
		PUSH IY
		LD IYL,0			; 
NEXT_ICOM_DEV	PUSH IX
		PUSH HL
		LD HL,EXITDEV
		EX (SP),HL
		PUSH HL
		ADD A,A
		ADD A,LOW (TABLDEV)
		LD L,A
		ADC A,HIGH (TABLDEV)
		SUB L
		LD H,A
		LD A,(HL)
		INC HL
		LD H,(HL)
		LD L,A
		EX AF,AF'
		EX (SP),HL
		RET

EXITDEV		POP IX
		POP IY
		RET

;   
ICOM_DEV	EX AF,AF'
		EX (SP),HL
		LD A,(HL)
		INC HL
		EX (SP),HL
		PUSH IY
		LD IYL,1			; 
		JR NEXT_ICOM_DEV

TABLDEV		DW DEVFIND			;00  
		DW SET_VOL			;01  
		DW KOL_VOL			;02  
		DW SET_DEVICE			;03     LBA 
		DW TO_DRV			;04    
		DW COMHDDNEX			;05    HDD NEMO ( )

;   
;+0(1)-0-DRIVE A
;      1-DRIVE B
;      2-DRIVE C
;      3-DRIVE D
;      4-SD  ZC
;      5-SD  NEOGS
;      6-HDD NEMO
;      7-HDD SMUC
;+1(1)- SD- 0
;       HDD/CD 0-MASTER, 1-SLAVE
;+2(1)- ,   
;:
;00=01-FAT12
;01=06,0E-FAT16
;02=0B,0C-FAT32
;+3(4)- 
;+7(1)-

;    
;HL-    
; :
;A-- 
DEVFIND		XOR A
		LD (KOLDVOL),A			;  
		LD IX,ADRTVOL			;   
		LD A,IYL
		LD IYL,1
		AND A
		JR NZ,DEVFIND1
		LD HL,FOR_EXTERN
		PUSH HL
;NEMO
DEVFIND1	LD HL,BUFFSEC			;     (512 )
		CALL COMHDDN
		DB Hddinit			;     
		LD A,H
		AND A
		LD A,HDDN+MASTER
		LD HL,BUFFSEC
		PUSH IY
		CALL Z,RD0HDD			;     - HDD MASTER
		POP IY
;SMUC
		IF SMUC=1
		LD HL,BUFFSEC
		CALL COMHDDS
		DB 0				;     
		LD A,H
		AND A
		LD A,HDDS+MASTER
		LD HL,BUFFSEC
		PUSH IY
		CALL Z,RD0HDDS			;     - HDD MASTER
		POP IY
		ENDIF
;SD ON NEOGS
		CALL INSTSDD			;C  SD   NEOGS
		AND A
		JR NZ,DEVFND1			;   NEOGS  
		CALL COMSDG
		DB 0				; SD   NEOGS
		AND A
		PUSH IY
		CALL Z,RD0SDG			;   
		POP IY
;SD ON Z-CONTROLLER
DEVFND1		CALL COMSDZ
		DB 0				; SD 
		AND A
		PUSH IY
		CALL Z,RD0SD			;   
		POP IY
		LD IYL,0
		CALL SETVOLD			;      
		SCF
		RET Z				;      
		DEC A
		CALL SET_VOL1			;   
		RET C
;     
IKOL_VOL	LD HL,(ADRTEKV)			;   
		INC HL
		INC HL
		LD A,(HL)			; 
		LD DE,(KOLDVOL)			;D-  , E-  
		LD HL,ADRTVOL			;    
		AND A
		RET

KOL_VOL		LD HL,(ADRTEKV)			;   
		INC HL
		INC HL
		LD A,(HL)			; 
		LD HL,(KOLDVOL)			;D-  , E-  
		LD (REG_E),HL
		AND A
		PUSH AF
		POP HL
		LD (REG_F),HL
		RET

FOR_EXTERN	PUSH AF
		POP HL
		LD (REG_F),HL
		LD BC,0X100			;  256 
		LD DE,(REG_L)			;  
		LD HL,ADRTVOL
		LD A,D
		CP 0XC0				;   
		JR NC,LDIR4EXTRN
		CP 0X7F				;   
		JR C,LDIR4EXTRN
		PUSH BC
		LD BC,WIN_A1			;    2- 
		LD A,0X7D
		OUT (C),A			;  2-   1- 
		LD A,D
		SUB 0X40
		LD D,A				;  
		POP BC
		LD A,E
		AND A				;   256 
		JR Z,LDIR4EXTRN2
		NEG
		LD C,A
		NEG
		LD B,0
		LDIR				;  ,    
		LD C,A
		LD B,0
LDIR4EXTRN2	LDIR				;  
		LD BC,WIN_A1
		LD A,0X7A
		OUT (C),A			;   1- 
		JR LDIR4EXTRN1

LDIR4EXTRN	LDIR
LDIR4EXTRN1	LD HL,(KOLDVOL)
		LD (REG_E),HL
		RET

;      
SETVOLD		LD A,IXL
		RRCA
		RRCA
		RRCA
		AND 0X1F
		LD (KOLDVOL),A
		AND A
		RET

;   SD  NEOGS
RD0SDG		LD HL,BUFFSEC
		LD A,SDG
		PUSH AF
		LD DE,0
		LD B,D
		LD C,E
		PUSH HL
		CALL COMSDG
		DB 2
		JR RD0HDD_

;   SD  Z-
RD0SD		LD HL,BUFFSEC
		LD A,SDZ
		PUSH AF
		LD DE,0
		LD B,D
		LD C,E
		PUSH HL
		CALL COMSDZ
		DB 2
		JR RD0HDD_

;   HDD SMUC
		IF SMUC=1
RD0HDDS		PUSH AF
		PUSH HL
		LD (ADRTEKV),IX
		LD B,A
		AND 0X80
		RLCA
		LD (IX+1),A
		LD A,B
		LD DE,0
		LD B,D
		LD C,E
		CALL COMHDDS
		DB 2
		JR RD0HDD_
		ENDIF

;   HDD NEMO
RD0HDD		PUSH AF
		PUSH HL
		LD (ADRTEKV),IX
		LD B,A
		AND 0X80
		RLCA
		LD (IX+1),A
		LD A,B
		LD DE,0
		LD B,D
		LD C,E
		CALL COMHDDN
		DB 2
RD0HDD_		LD DE,0X01BE		;  0     MBR
		POP IY
		PUSH IY
		ADD IY,DE		;     
		LD BC,0X0400		;  4      FAT
RD0HDD0		LD A,(IY)		;  16  
		AND A			;   0
		JR Z,RD0HDD1
		CP 0X80			; 0X80 (  )
		JR NZ,RD0HDD2
RD0HDD1		LD A,(IY+4)		;  
		CALL CP_RAZD		;  
		JR NZ,RD0HDD2		;  FAT   16  
		INC C
RD0HDD2		LD DE,0X10
		ADD IY,DE
		DJNZ RD0HDD0		;  16    MBR
		LD A,C
		AND A
		POP HL
		JP NZ,SCANMBR
		PUSH HL
		POP IY
		LD C,(IY+0X0D)
		XOR A
		LD E,A
		LD B,8
		RR C
		ADC A,0
		DJNZ $-4
		DEC A
		JR NZ,$+3
		INC E
		LD A,(IY+0X0E)
		OR (IY+0X0F)
		JR Z,$+3
		INC E
		LD A,(IY+0X13)
		OR (IY+0X14)
		JR NZ,$+3
		INC E
		LD A,(IY+0X20)
		OR (IY+0X21)
		OR (IY+0X22)
		OR (IY+0X22)
		JR NZ,$+3
		INC E
		LD A,(IY+0X15)
		AND 0XF0
		CP 0XF0
		JR NZ,$+3
		INC E
		LD A,E
		CP 4
		INC SP
		INC SP
		RET NZ
		DEC SP
		DEC SP
		POP AF
		BIT 7,A
		LD B,0
		JR Z,$+3
		INC B
		AND 0X7F
		LD C,A
		PUSH IX
		POP HL
		XOR A
		LD (HL),C
		INC HL
		LD (HL),B
		INC HL
		LD (HL),0XFF
		INC HL
		LD (HL),A
		INC HL
		LD (HL),A
		INC HL
		LD (HL),A
		INC HL
		LD (HL),A
		INC HL
		LD (HL),A
		LD DE,8
		ADD IX,DE
		CALL SETVOLD
		DEC A
		LD (IX-6),0XFF
		JP SET_VOL

; :
;A-BIT 7-0/1-MASTER/SLAVE
;BITS 6-0- 
SCANMBR		POP AF
		LD DE,0X01BE
		ADD HL,DE
		EXX
		BIT 7,A
		LD B,0
		JR Z,$+3
		INC B
		AND 0X7F
		LD C,A
		EXX
		LD B,0
		LD A,4
SCNMBR0		EX AF,AF'
		LD A,(HL)
		LD C,4
		ADD HL,BC
		LD C,0X0C
		AND A
		JR Z,SCNMBR1
		CP 0X80
		JR NZ,SCNMBR2
SCNMBR1		LD A,(HL)
		AND A
		JR Z,SCNMBR2
		CALL CP_RAZD
		JR NZ,SCNMBR2
SCNMBR3		EXX
		LD (IX),C
		LD (IX+1),B
		EXX
		LD (IX+2),E
		LD C,4
		PUSH IX
		POP DE
		INC DE
		INC DE
		INC DE
		ADD HL,BC
		LDI
		LDI
		LDI
		LDI
		LD (IX+7),0
SCNMBR4		LD C,8
		ADD IX,BC
		LD C,4
SCNMBR2		ADD HL,BC
		EX AF,AF'
		DEC A
		JR NZ,SCNMBR0
SCNMBR5		CALL SETVOLD
		SCF
		RET Z
		DEC A
; 
SET_VOL		LD L,A
		LD A,IYL
		AND A
		LD A,L
		JR NZ,SET_VOL1
		LD A,(REG_A)
SET_VOL1	LD HL,KOLDVOL
		CP (HL)
		CCF
		RET C
		LD (SETDVOL),A
		LD L,A
		LD H,0
		ADD HL,HL
		ADD HL,HL
		ADD HL,HL
		LD DE,ADRTVOL
		ADD HL,DE
		LD (ADRTEKV),HL
		LD A,(HL)
		CP 4
;		LD HL,DISKETA		;  
		JR C,SET_DRV
		SUB 4
		LD HL,COMSDZ
		JR Z,SET_DRV
		DEC A
		LD HL,COMSDG
		JR Z,SET_DRV
		DEC A
		LD HL,COMHDDN
		IF SMUC=1
		JR Z,SET_DRV
		LD HL,COMHDDS
		ENDIF
SET_DRV		LD (GO_DEV),HL
		XOR A
		RET

SET_DEVICE	PUSH AF
		PUSH HL
		LD A,B
		AND 0X0F
		LD B,A
		LD HL,(ADRTEKV)
		INC HL
		LD A,(HL)
		AND 1				;MASTER  SLAVE?
		RLCA
		RLCA
		RLCA
		RLCA
		OR 0XE0				; LBA 
		OR B
		LD B,A				;   MASTER  SLAVE
		POP HL
		POP AF
		RET

;  
CP_RAZD		LD E,1			;FAT16
		CP 4
		RET Z
		CP 6
		RET Z
		CP 0X0E
		RET Z
		LD E,2			;FAT32
		CP 0X0B
		RET Z
		CP 0X0C
		RET Z
		LD E,0			;FAT12
		CP 1
		RET

;    HDD NEMO
COMHDDNEX	RST 0X10
		LD A,(REG_A)
		LD DE,(REG_E)
		LD BC,(REG_C)
		LD HL,(REG_L)
		JP COMHDDN
