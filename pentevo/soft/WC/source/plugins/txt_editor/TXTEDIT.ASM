;Ilich Editor v0.6;(C) KOSHI/MGN 2018;-------------------------------------------------------------------------------HEADER  EQU #6000BINAR   EQU HEADER+512        ORG HEADERWLD     EQU #6006; Plugin System Call PointTMN     EQU #6009; TimerDFCOL   EQU %00010111; Default ColorMDCOL   EQU %01010111; Marked ColorCLCWNDC EQU %01001111; Inspector Window ColorSRHWNDC EQU %01001111; Search Window ColorNFNWNDC EQU %00101111; Not Found Window ColorMDLTR   EQU 1; Marked LeftToRightLNZ     EQU 1; Upper offset on ScreenLNZ2    EQU 1; Lower offset on ScreenIND     EQU 4; Page UP Ind. for MARKEDPGZ     EQU 0; TXT Buffer Start PagePGM     EQU #3F; TXT Buffer End Page;Calc BufferCBUF    EQU #C000-#500CBUF1   EQU CBUF+256;DECOD2 BufferD2BUF   EQU CBUF1+256;BufferBUF2    EQU D2BUF+256;Const1,0,Const2,0 for EXPsBUF3    EQU BUF2+256;Source EXPSPSAFE  EQU BUF3;Calc PrefxC1B     EQU #01;1 Byte IndexC2B     EQU #02;2 Byte IndexCLA     EQU #04;Constant IndexCP1     EQU #05;+CP2     EQU #06;-CP3     EQU #07;*CP4     EQU #08;/CP5     EQU #09;\ ModCP6     EQU #0A;[ HiCP7     EQU #0B;] Low;-------------------------------------------------------------------------------;PLUGIN HEADER        DS 16; Reserved        DB "WildCommanderMDL"; Header        DB #09; v0.9 of Plugin System Needed        DB 0; Reserved        DB 2; Pages        DB 0; Page to #8000        DB 0,1+(ENDPL-PLUGIN)/512; Main Code (page and size).5      DB 0,0        DS 16        DS 32*3; File extensions        DB 0        DW #FFFE,#000F; Max File Size        DB "TXT Editor v0.6                 "; Plugin Name        DB #14,"Edit  ";-------------------------------------------------------------------------------        ORG #8000,BINARENTRYN  EQU #A100FLLOAD  EQU ENTRYN-1FLMAKE  EQU ENTRYN-5WHEAD   EQU ENTRYN+512;-------PLUGIN  LD (DAHL),HL,(DADE),DE        XOR A        LD (ESTA),A        LD (CHANGES),A        LD (MARKED),A        LD HL,BC        LD DE,ENTRYN        LD BC,256:LDIR        CALL LOAD        CALL GEDPL        LD IX,PLWND:CALL PRWOW        CALL NAMETOH        XOR A        LD (CRX),A        LD A,PGZ        LD (PGHLP+2),A        LD (LNHLP+2),A        LD (LHLCR+2),A        LD HL,0        LD (PGHLP),HL        LD (LNHLP),HL        LD (LHLCR),HL        CALL REFRESH        LD HL,#0100,A,#FE:CALL ISTRMAIN    EI:HALT        LD A,#FC:CALL ISTR,STUPD        LD A,#03:CALL ISTR        CALL SHIFT:JR Z,NOSHFT        CALL LFFF:LD A,5:JR NZ,DADAN        CALL UPPP:LD A,6:JR NZ,DADAN        CALL DWWW:LD A,1:JR NZ,DADAN        CALL END:LD A,2:JR NZ,DADAN        CALL PGDN:LD A,3:JR NZ,DADAN        CALL RGGG:LD A,4:JR Z,NOSHFTDADAN   LD (DADAH+1),A,C,A        LD A,(MARKED):OR A:JR NZ,DADA        LD A,C:CP 5:JR NC,DADAEX        LD HL,LHLCR,DE,BHLBLK,BC,3:LDIRDADA    LD A,MDLTR,(REFFLG),ADADAH   LD A,0        DEC A:PUSH AF:CALL Z,GODW:POP AF        DEC A:PUSH AF:CALL Z,SSE:POP AF        DEC A:PUSH AF:CALL Z,GOPD:POP AF        DEC A:PUSH AF:CALL Z,GORG:POP AF        DEC A:PUSH AF:CALL Z,GOLF:POP AF        DEC A:CALL Z,GOUPDADAEX  XOR A:LD (REFFLG),A        JP MAINNOSHFT  CALL CTRL:JR Z,NOAD        CALL HOME,NZ,GOSTART:JP NZ,MAIN        CALL END,NZ,GOEND:JP NZ,MAIN        LD A,1:CALL KBSCN        CP "s":CALL Z,QSAVE        CP "f":CALL Z,SEARCH        CP "g":CALL Z,SEARCHNEXT        CP "c":CALL Z,COPY        CP "v":CALL Z,PASTE        CP "x":CALL Z,CUT        JP MAINNOAD    CALL TABK,NZ,INSPECTOR:JP NZ,MAIN        CALL HOME,NZ,SSQ        CALL END,NZ,SSE        CALL ENKE,NZ,GO0D        CALL BSPC,NZ,BSPACE        CALL DEL,NZ,DELETE;-------        XOR A:CALL KBSCN,NZ,SMBADD        CALL LFFF,NZ,GOLF        CALL RGGG,NZ,GORG        CALL UPPP,NZ,GOUP        CALL DWWW,NZ,GODW        CALL PGUP,NZ,GOPU        CALL PGDN,NZ,GOPD        CALL F1,NZ,F1MENU        CALL ESC:JP Z,MAIN;-------EXIT    CALL SAVECH:JP C,MAIN        CALL RRESB        LD A,(ESTA)        RET;---------------------------------------;Move Page to File StartGOSTART      CALL CRM13UGGSTART      CALL CR13U:JP C,GGSTART             LD A,PGZ,(PGHLP+2),A             LD HL,0,(PGHLP),HL:CALL REFRESH             LD A,1:OR A:RET;-------;Move Page to File EndGOEND        CALL CRM13DGGEND        CALL CR13D:JP C,GGEND             LD HL,LHLCR,DE,PGHLP,BC,3:LDIR             LD A,(IX+5):SUB LNZ+1+LNZ2             LD B,AGEND         PUSH BC:CALL PGMUZ             POP BC:JR NC,Gend             DJNZ GENDGend         CALL FILE_END_FND             LD A,1:OR A:RET;-------;Move Page UpGOPU         CALL CRM13U             LD A,(IX+5):SUB LNZ+1             LD B,APGU_CUR_MOVE PUSH BC:CALL CRM13U,PGMUZ             POP BC:JR NC,FILE_UP_FND             DJNZ PGU_CUR_MOVE             CALL INCCURFILE_UP_FND  LD A,(CRX):CALL CRMFWD             JP REFRESH;-------;Move Page DownGOPD         LD A,(IX+5):SUB LNZ+1             LD B,APGD_CUR_MOVE PUSH BC:CALL CRM13D,C,PGMD             POP BC:JR NC,FILE_END_FND             DJNZ PGD_CUR_MOVEFILE_END_FND LD A,(CRX):CALL CRMFWD                                JP REFRESH;-------;Move Cursor UpwardGOUP    CALL CRM13U        CALL CRM13U,C,INCCUR        LD A,(CRX):CALL CRMFWD        LD A,(CRP+1)        CP LNZ:CALL Z,PGMUZ        JP REFRESH;-------;Move Cursor DownwardGODW    CALL CRM13D:JR NC,GOD        LD A,(CRX):CALL CRMFWD        LD A,(CRP+1):INC A,A        CP (IX+5):CALL NC,PGMDGOD     JP REFRESH;-------;Move Cursor LeftGOLF    LD HL,(CRP)        LD A,H:CP LNZ:JR NZ,GOlf        LD A,L:OR A:CALL Z,PGMUZGOlf    CALL DECCUR        CALL REFRESH        LD A,(CRP),(CRX),A        RET;-------;Move Cursor RightGORG    LD A,(CRP):CP 80-1:RET NC        LD A,(CRP+1):INC A,A        CP (IX+5):CALL NC,GOrg        CALL INCCUR        CALL REFRESH        LD A,(CRP),(CRX),A        RETGOrg    CALL INCCUR:RET NC        PUSH AF:CALL DECCUR        POP AF:CP #0D+1:RET NC        JP PGMD;-------GO0D    CALL MARK_KILL:JR NC,G0DNO        LD A,#D:CALL INCLCR:JR G0dnoG0DNO   LD A,#D:CALL INCLCR:RET NC        LD A,(CRP+1):INC A,A        CP (IX+5):CALL NC,PGMDG0dno   CALL REFRESH        LD A,(CRP),(CRX),A        JP CHA;-------SMBADD  PUSH AF:CALL MARK_KILL        POP BC:LD A,B:JR NZ,INSM        LD BC,(INOV):BIT 0,C:JR Z,INSM        PUSH AF:CALL INCCUR        POP BC:RET NC        CP #0D+1:LD A,B:JR C,OVRM        CALL DECLCRN        CALL REFRESH        LD A,(CRP),(CRX),A        JP CHAOVRM    PUSH AF:CALL DECCUR        POP AFINSM    CALL INCLCR:RET NC        CALL REFRESH        LD A,(CRP),(CRX),A        JP CHA;-------SSQ     CALL CRM13U,C,INCCUR        CALL REFRESH        LD A,(CRP),(CRX),A        RETSSE     CALL CRM13D,C,DECCUR        CALL REFRESH        LD A,(CRP),(CRX),A        RET;-------DELETE  CALL MARK_KILL:JR NZ,Bspc        CALL INCRCR,REFRESH:JP CHABSPACE  CALL MARK_KILL:JR NZ,Bspc        CALL DECLCR:RET NC        LD HL,(CRP)        LD A,H:CP LNZ:JR NZ,Bspc        LD A,L:OR A:CALL Z,PGMUZBspc    CALL REFRESH        LD A,(CRP),(CRX),A        JP CHA;-------STUPD   AND %10000000:RLCA:LD (INOV),A:RET;-------CHA     LD A,1,(CHANGES),A:RET;---------------------------------------MARK_KILL LD A,(MARKED):OR A:RET Z          LD A,(BHLBLK+2),BC,(PGHLP+2)          CP C:JR C,MARKCURGG,Z,$+4,NC,MARKCUROK          LD HL,(BHLBLK),DE,(PGHLP)          OR A:SBC HL,DE:JR Z,MARKCUROK,NC,MARKCUROKMARKCURGG LD HL,BHLBLK,DE,PGHLP,BC,3:LDIR          LD A,(IX+5):SUB LNZ+1+IND          LD B,AGMARKPG   PUSH BC:CALL PGMUZ          POP BC:JR NC,GMARKGG          DJNZ GMARKPGGMARKGG   CALL MARKCUROK          SCF          RETMARKCUROK LD HL,BHLBLK,DE,LHLCR,BC,3:LDIR          LD A,1:OR A          RET;---------------------------------------MRK_REF LD HL,LHLCR,DE,EHLBLK,BC,3:LDIR        LD A,(BHLBLK+2)        LD HL,(EHLBLK+2)        CP L:JR C,MRK_OK,Z,$+4,NC,MRK_BAD        LD HL,(BHLBLK),DE,(EHLBLK)        OR A:SBC HL,DE:JR C,MRK_OKMRK_BAD XOR A:JR REFAMRK_OK  LD A,1:JR REFAREFRESH LD A,(REFFLG):OR A:JR NZ,MRK_REFREFA    LD (MARKED),A;---------------------------------------PAGE    ;i: PGHLP - Offset(2) + Page(1)        XOR A:LD (CRFLG),A        LD A,(PGHLP+2),(LNHLP+2),A        LD HL,(PGHLP),(LNHLP),HL        LD HL,#0000+LNZ*256,(XY),HLMARA    CALL LINE        LD HL,XY+1:INC (HL)        LD A,(HL):INC A        CP (IX+5):JP C,MARA        RET;---------------------------------------LNE22   JP LNE2;-------LINE    ;Print Line;       i: LNHLP - Offset(2) + Page(1);       o: LNHLP - Next Line        LD HL,0,(CRPOZ),HL        LD HL,(LNHLP),(LNTMP),HL        LD A,(LNHLP+2),(LNTMP+2),A:CALL MNG0VPL        LD DE,(XY):CALL GADRW:EX DE,HLBROOT   LD HL,(LNHLP),BC,(LHLCR),B,#D+1BROO    LD A,C:CP L:JR Z,RYZRAZ     LD A,(HL):CP B:JR C,LNE22ROZ     BIT 7,E:JR NZ,IGLN        LD (DE),A:INC EIGLN    INC HL:BIT 6,H:JR NZ,CRASHX        LD A,C:CP L:JR Z,RYZ        LD A,(HL):CP B:JR C,LNE2        BIT 7,E:JR NZ,IGLN2        LD (DE),A:INC EIGLN2   INC HL:BIT 6,H:JP Z,BROO        JR CRASHXRYZ     LD A,(LHLCR+1):CP H:JP NZ,RAZ        LD A,(LNHLP+2),C,A        LD A,(LHLCR+2):CP C:JR NZ,RAZ        PUSH DE        LD HL,RHLCR,DE,LNHLP.3      LDI        CALL INCLN; Line Offset(3) + 1        PUSH AF        LD A,(LNHLP+2):CALL MNG0VPL        POP AF        POP DE        LD (CRPOZ),DE        LD (CRP),DE        LD A,(XY+1),(CRP+1),A        LD HL,(LNHLP),BC,(LHLCR),B,#D+1        LD A," ":JP NC,ROZ        JP RAZCRASHX  LD A,H:AND %00111111:LD H,A        LD A,(LNHLP+2):INC A        CP PGM+1:JR NC,LNE1        LD (LNHLP+2),A        LD (LNHLP),HL        CALL MNG0VPL        JP BROOTLNE1    DEC HL        LD A,H:AND %00111111:LD H,ALNE2    LD (LNHLP),HL        PUSH DE:CALL INCLN        POP HL        CALL ESTRCLR;EndStringClear;-------        CALL COLORS;Fill Color        CALL CURTAT;Print Cursor        RET;---------------------------------------MCOLOR  ;Show Marked        INC E:SET 7,E        EXX:LD HL,(BHLBLK),DE,(EHLBLK),BC,(BHLBLK+2),A,(EHLBLK+2),B,A        EXXSLOWCOL EXX        LD A,(LNTMP+2):CP C:JR C,DFCLSET        LD A,(LNTMP+1):CP H:JR C,DFCLSET,NZ,LOWSKIP        LD A,(LNTMP+0):CP L:JR C,DFCLSETLOWSKIP LD A,(LNTMP+2):CP B:JR C,MDCLSET,NZ,DFCLSET        LD A,(LNTMP+1):CP D:JR C,MDCLSET,NZ,DFCLSET        LD A,(LNTMP+0):CP E:JR C,MDCLSETDFCLSET LD A,DFCOL:JR CLSETMDCLSET LD A,MDCOLCLSET   EXX        PUSH HL,AF        CALL INCTMP        POP AF,HL        LD (HL),A:INC L:LD A,L:CP E:JR C,SLOWCOL        RES 7,E        LD A,80:SUB E:JR C,SLOWEND,Z,SLOWEND        LD B,A,A,DFCOL,(HL),A:INC L:DJNZ $-2SLOWEND         RETCOLORS  LD L,E,E,%10000000        EX DE,HL        LD A,(MARKED):OR A:JR NZ,MCOLOR;Default Color to Line        PUSH HL        LD A,DFCOL.80     LD (HL),A:INC L        POP BC        RET;---------------------------------------CURTAT  ;Set Cursor        LD HL,(CRPOZ):LD A,H:OR L:RET Z        LD (CRFLG),A        BIT 7,L:RET NZ        SET 7,L        LD A,(HL):RRD        SET 7,(HL)        RET;-------DAFAQ   LD A,80:SUB L:RET Z,C        LD B,A,(HL),C:INC L:DJNZ $-2:RETESTRCLR ;Clearing End Of String        LD C," "        LD A,L        CP 64:JR NC,DAFAQ        ADD A,A:LD (BAKC+1),ABAKC    JR $.80     LD (HL),C:INC L        RET;---------------------------------------PGMD    LD A,(PGHLP+2):CALL MNG0VPLPGmd    CALL INCPG:RET NC        LD A,E:CP #0D+1:JR NC,PGmd        RETPGMUZ   CALL PGMU        CALL PGMU,C,INCPG        RETPGMU    LD A,(PGHLP+2):CALL MNG0VPL        LD HL,(PGHLP)PGmu    DEC HL        LD A,H:CP #40:JR NC,ILYA2GILIAN  LD A,(HL):CP #0D+1:JP NC,PGmu        LD (PGHLP),HL        RETILYA2   INC HL:LD (PGHLP),HL        DEC HL        AND %00111111:LD H,A        LD A,(PGHLP+2)        CP PGZ:RET Z:DEC A        LD (PGHLP+2),A        LD (PGHLP),HL        PUSH HL,DE:CALL MNG0VPL        POP DE,HL        JP GILIAN;---------------------------------------DZT     LD DE,#3FFF:JP ZZTFAST    LD A,(RHLCR+2):INC A        CP PGM+1:JR NC,DZT        LD (RHLCR+2),A        PUSH BC:CALL MNGCVPL        POP BC        SET 7,D        SET 6,D        JP FASTBCRM13D  LD A,(LHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD A,(RHLCR+2)        EXA:LD A,65:CALL WLD;=CALL MNGCVPL        LD C,#0D+1CR13D   LD HL,(LHLCR)        LD DE,(RHLCR)        SET 7,D        SET 6,DCR13DD  INC DE:BIT 7,D:JR Z,FASTFASTB   LD A,(DE),(HL),A        INC HL:BIT 6,H:JR NZ,FAST2FAST2B  CP C:JP NC,CR13DDZZT     LD (LHLCR),HL        RES 7,D        RES 6,D        LD (RHLCR),DE        RET;-------FAST2   PUSH AF        LD A,H:AND %00111111:LD H,A        LD A,(LHLCR+2):INC A        LD (LHLCR+2),A        PUSH BC:CALL MNG0VPL        POP BC        POP AF        JP FAST2B;---------------------------------------     AZT     LD HL,0:JP AZZFAZT    LD A,H:AND %00111111:LD H,A        LD A,(LHLCR+2):CP PGZ:JR Z,AZT:DEC A        LD (LHLCR+2),A        PUSH BC:CALL MNG0VPL        POP BC        JP FAZTBCRM13U  LD A,(LHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD A,(RHLCR+2)        EXA:LD A,65:CALL WLD;=CALL MNGCVPL        LD C,#0D+1CR13U   LD HL,(LHLCR)        LD DE,(RHLCR)        SET 7,D        SET 6,DCR13UU  DEC HL:BIT 7,H:JR NZ,FAZTFAZTB   LD A,(HL),(DE),A                DEC DE:BIT 6,D:JR Z,FAZT2FAZT2B  CP C:JP NC,CR13UUAZZ     LD (LHLCR),HL        RES 7,D        RES 6,D        LD (RHLCR),DE        RETFAZT2   SET 6,D        PUSH AF        LD A,(RHLCR+2):DEC A        LD (RHLCR+2),A        PUSH BC:CALL MNGCVPL        POP BC        POP AF              JP FAZT2B;---------------------------------------SAZT    LD HL,0:JP SAZZSFAZT   LD A,H:AND %00111111:LD H,A        LD A,(LHLCR+2):CP PGZ:JR Z,SAZT:DEC A        LD (LHLCR+2),A        PUSH BC:CALL MNG0VPL        POP BC        JP SFAZTBSCRM13U LD A,(LHLCR+2):CALL MNG0VPL        LD A,(RHLCR+2):CALL MNGCVPL        LD BC,#0D+1        LD HL,(LHLCR)        LD DE,(RHLCR)        SET 7,D        SET 6,DSCR13UU DJNZ S:LD B,1S       DEC HL:BIT 7,H:JR NZ,SFAZTSFAZTB  LD A,(HL),(DE),A                DEC DE:BIT 6,D:JR Z,SFAZT2SFAZT2B CP C:JP NC,SCR13UUSAZZ    LD (LHLCR),HL        RES 7,D        RES 6,D        LD (RHLCR),DE        EXA        XOR A:SUB B        DEC A:LD B,A        EXA        RETSFAZT2  SET 6,D        PUSH AF        LD A,(RHLCR+2):DEC A        LD (RHLCR+2),A        PUSH BC:CALL MNGCVPL        POP BC        POP AF              JP SFAZT2B;---------------------------------------CRMFWD  OR A:RET Z        LD B,ACRFWD   PUSH BC:CALL INCCUR        POP BC:RET NC        CP #0D+1:JP C,DECCUR        DJNZ CRFWD        SCF        RET;---------------------------------------INCTMP  LD HL,(LNTMP):INC HL        LD A,H:CP #40:JR NC,AKIRA        LD (LNTMP),HL        RETAKIRA   AND %00111111:LD H,A        LD A,(LNTMP+2):INC A        CP PGM+1:RET NC        LD (LNTMP+2),A        LD (LNTMP),HL        RET;---------------------------------------INCLN   LD HL,(LNHLP):INC HL        LD A,H:CP #40:JR NC,CRASH        LD (LNHLP),HL        SCF        RETCRASH   AND %00111111:LD H,A        LD A,(LNHLP+2):INC A        CP PGM+1:RET NC        LD (LNHLP+2),A        LD (LNHLP),HL        SCF        RET;---------------------------------------INCPG   LD HL,(PGHLP),E,(HL):INC HL        LD A,H:CP #40:JR NC,ILYA        LD (PGHLP),HL        SCF        RETILYA    AND %00111111:LD H,A        LD A,(PGHLP+2):INC A        CP PGM+1:RET NC        LD (PGHLP+2),A        LD (PGHLP),HL        PUSH DE;CALL MNG0VPL        EXA:LD A,80:CALL WLD        POP DE        SCF        RET;---------------------------------------INCLCR  ;Increment Left Cursor;        i: A - Char to Add;        o:NC - Failed;           C - OK        PUSH AF        LD A,(LHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        POP DE        LD HL,(LHLCR),(HL),D:INC HL        LD A,H:CP #40:JR NC,GRAD        LD A,(LHLCR+2)GRADB   LD DE,(RHLCR)        PUSH HL:OR A:SBC HL,DE        POP HL:JR NZ,LEQR        LD BC,(RHLCR+2):CP C:RET ZLEQR    LD (LHLCR+2),A        LD (LHLCR),HL        SCF        RET;-------GRAD    AND %00111111:LD H,A        LD A,(LHLCR+2):INC A        JP GRADB;---------------------------------------DECLCRN LD C,A        LD HL,(LHLCR):DEC HL        LD A,H:CP #40:JR NC,NULL        LD A,(LHLCR+2)NULLB   PUSH HL,BC:CALL MNG0VPL        POP BC,HL        LD (HL),C        SCF        RETNULL    AND %00111111:LD H,A        LD A,(LHLCR+2)        CP PGZ:RET Z:DEC A        JP NULLB;---------------------------------------DECLCR  LD HL,(LHLCR):DEC HL        LD A,H:CP #40:JR NC,CRASXCRASXB  LD (LHLCR),HL        SCF        RETCRASX   AND %00111111:LD H,A        LD A,(LHLCR+2)        CP PGZ:RET Z:DEC A        LD (LHLCR+2),A        JP CRASXB;-------INCRCR  LD HL,(RHLCR):INC HL        LD A,H:CP #40:JR NC,GRADXGRADXB  LD (RHLCR),HL        SCF        RETGRADX   AND %00111111:LD H,A        LD A,(RHLCR+2):INC A        CP PGM+1:RET NC        LD (RHLCR+2),A        JP GRADXB;---------------------------------------CRAS    AND %00111111:LD H,A        LD A,(LHLCR+2)        CP PGZ:RET Z:DEC A        LD (LHLCR+2),A        JP CRASBDECCUR  LD HL,(LHLCR):DEC HL        LD A,H:CP #40:JR NC,CRASCRASB   LD (LHLCR),HL;-------        LD A,(LHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD HL,(LHLCR)        LD A,(HL)        PUSH AF        LD A,(RHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD HL,(RHLCR)        POP AF        LD (HL),A;-------        EXA        LD HL,(RHLCR):DEC HL        LD A,H:CP #40:JR NC,CRAShCRAShB  LD (RHLCR),HL        EXA        SCF        RET;-------CRASh   AND %00111111:LD H,A        LD A,(RHLCR+2):DEC A        LD (RHLCR+2),A        JP CRAShB;---------------------------------------CRASH2  AND %00111111:LD H,A        LD A,(RHLCR+2):INC A        CP PGM+1:RET NC        LD (RHLCR+2),A        JP CRASH2BINCCUR  LD HL,(RHLCR):INC HL        LD A,H:CP #40:JR NC,CRASH2CRASH2B LD (RHLCR),HL;-------        LD A,(RHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD HL,(RHLCR)        LD A,(HL)        PUSH AF        LD A,(LHLCR+2)        EXA:LD A,80:CALL WLD;=CALL MNG0VPL        LD HL,(LHLCR)        POP AF        LD (HL),A;-------        EXA        LD HL,(LHLCR):INC HL        LD A,H:CP #40:JR NC,CRASh2CRASh2B LD (LHLCR),HL        EXA        SCF        RET;-------CRASh2  AND %00111111:LD H,A        LD A,(LHLCR+2):INC A        LD (LHLCR+2),A        JP CRASh2B;---------------------------------------LOAD    CALL LOADFL        LD HL,(DAHL)        LD DE,(DADE)        CALL LNT3        LD (SHLA+2),A        LD (SHLA),HL        LD A,PGM,(DHLA+2),A        LD HL,#3FFF,(DHLA),HL        LD HL,(DAHL)        LD DE,(DADE)        CALL LDDRR        LD A,(DHLA+2),(RHLCR+2),A        LD HL,(DHLA),(RHLCR),HL        XOR A:LD (LHLCR+2),A        LD HL,0,(LHLCR),HL        RET;-------LOADFL  XOR A:LD (APG),ALFL     LD A,(APG):CALL MNGCVPL        LD HL,#C000,B,32:CALL LOAD512        CP #0F:RET Z        LD HL,APG:INC (HL)        LD A,(HL):CP PGM+1:RET NC        JR LFL;---------------------------------------LDDRR   ;i: [DE,HL] - Lenght;              SHLA - Source;              DHLA - Dest        LD A,L:OR H,E,D:RET Z        LD (LHLA),HL        LD (LHLA+2),DEDDRR    LD A,(LHLA+3):OR A:RET NZ        LD A,(SHLA+2):CALL MNG0VPL        LD A,(DHLA+2):CALL MNGCVPL        LD HL,(SHLA)        LD DE,(DHLA)        PUSH HL:OR A:SBC HL,DE        POP HL:LD BC,HL        JR C,$+4:LD BC,DE        INC BC        PUSH HL,DE        LD DE,(LHLA+2)        LD HL,(LHLA)        OR A:SBC HL,BC:JR NC,$+3:DEC DE        LD A,D:OR E,H,L:JR NZ,$+4:LD D,1        LD (LHLA+2),DE        LD (LHLA),HL        LD A,D:OR A:JR Z,CRH        ADD HL,BC:LD BC,HLCRH     POP DE,HL        LD A,D:AND %00111111:OR #C0        LD D,A        LDDR        LD A,D        CP #C0:JR NC,MGN        EXA        LD A,(DHLA+2):DEC A        LD (DHLA+2),A        EXAMGN     AND %00111111        LD D,A        LD A,H        CP #40:JR C,MGN2        AND %00111111        LD H,A        LD A,(SHLA+2):DEC A        LD (SHLA+2),AMGN2    LD (SHLA),HL        LD (DHLA),DE        JP DDRR;---------------------------------------LDIRR   ;i: [DE,HL] - Lenght;              SHLA - Source;              DHLA - Dest        LD A,L:OR H,E,D:RET Z        LD (LHLA),HL        LD (LHLA+2),DEDIRR    LD A,(LHLA+3):OR A:RET NZ        LD A,(SHLA+2):CALL MNG0VPL        LD A,(DHLA+2):CALL MNGCVPL        LD HL,(SHLA)        LD DE,(DHLA)        SET 7,D        SET 6,DUBAL    LDI        BIT 6,D:JR Z,DDESTBALLU   BIT 6,H:JP Z,UBALDSORC   LD HL,#0000        LD A,(SHLA+2):INC A        LD (SHLA+2),A        CP PGM+1:JR NC,DSE        CALL MNG0VPL        JP UBALDDEST   LD A,(DHLA+2):INC A        LD (DHLA+2),A        CALL MNGCVPL        LD DE,#C000        JP BALLUDSE     LD (SHLA),HL        XOR A:LD (DE),A        RES 6,D        RES 7,D        LD (DHLA),DE        RET;---------------------------------------SAVECH  LD A,(CHANGES):OR A:RET Z        PUSH IX        LD IX,WMWND:CALL PRWOW        LD HL,ME01,DE,#0100:CALL TXTPR        LD A,#01:CALL YNSDM     EI:HALT        XOR A:CALL YN        CALL ESC:JR NZ,BACK2EDIT        CALL ENKE:JR Z,SDM        CALL RRESB        LD A,#FF:CALL YN:JR NZ,NOCH        CALL QSAVENOCH    POP IX        XOR A        RETBACK2EDIT CALL RRESB          POP IX          SCF          RET;---------------------------------------LNT3    ;i: [DE,HL] - File Lenght;        o:      HL - Offset in Page;                 A - Page        LD BC,1        OR A:SBC HL,BC:JR NC,$+3:DEC DE        LD A,H.2      SLA A:RL E        LD A,H:AND %00111111        LD H,A        LD A,E        RET;---------------------------------------PRTOSV  CALL NORMFL        LD A,(DHLA+2)        LD BC,(DHLA)YORGE   PUSH BC        LD HL,0,DE,HL        OR A:LD BC,#4000:CALL NZ,YOYO        POP BC        ADD HL,BC:JR NC,$+3:INC DE        RETYOYO    ADD HL,BC:JR NC,$+3:INC DE        DEC A:JR NZ,YOYO        RET;---------------------------------------TOWORK  CALL DECSRC        LD HL,(DHLA)        LD A,(DHLA+2)        PUSH HL        LD HL,SHLA        LD DE,DHLA        LD BC,3:LDIR        POP HL        LD (SHLA),HL        LD (SHLA+2),A        CALL DECSRC        LD HL,(LHLB)        LD DE,(LHLB+2)        CALL LDDRR        RETDECSRC  LD HL,(SHLA):DEC HL        LD A,H:CP #40:JR NC,GRDXGRDXB   LD (SHLA),HL        RETGRDX    AND %00111111:LD H,A        LD A,(SHLA+2):DEC A        CP PGM+1:RET NC        LD (SHLA+2),A        JP GRDXB;---------------------------------------NORMFL  CALL RCRTD        CALL INCRCR        LD HL,LHLCR,DE,DHLA,BC,3:LDIR        LD HL,RHLCR,DE,SHLA,C,3:LDIR        LD BC,(SHLA+2)        LD A,PGM:SUB C        LD BC,(SHLA)        LD HL,#4000:OR A:SBC HL,BC        LD BC,HL        CALL YORGE        LD (LHLB),HL        LD (LHLB+2),DE        CALL LDIRR        CALL DCRTR        RETRCRTD   LD HL,RHLCR,DE,RHLCR2,BC,3:LDIR:RETDCRTR   LD HL,RHLCR2,DE,RHLCR,BC,3:LDIR:RET;---------------------------------------NAMETOH LD HL,WHEAD,DE,HL:INC DE        LD BC,80,(HL),32:LDIR        LD HL,ENTRYN        LD DE,WHEAD        LD B,80-10NMTHD   LD A,(HL):CP 32:JR C,BAX        LD (DE),A:INC HL,DE        DJNZ NMTHDBAX     LD HL,WHEAD        LD DE,#0006        LD BC,80-16:CALL PRSRW        RET;---------------------------------------INSPECTOR PUSH IX          LD IX,CALCWND:CALL PRWOW          EXX:LD HL,CALCBUFL:EXX          LD HL,CALCBUF,DE,#0101,BC,#1800,A,#FD:CALL ISTRINSPMAIN  EI:HALT          CALL ENKE:JR NZ,INSPCALC          CALL TABK:JR NZ,INSP_EXIT          CALL ESC:JR NZ,INSP_EXIT          XOR A:CALL ISTR          LD A,2:CALL ISTR          JR INSPMAIN          INSP_EXIT CALL RRESB          POP IX          LD A,1:OR A          RETINSPCALC  LD HL,CALCBUF,DE,BUF3:CALL CALC_BUF_CONV          LD BC,0          LD DE,BUF3,A,(DE):OR A:CALL NZ,DECODER          LD HL,CALHEX          LD A,B:PUSH BC:CALL NORK:POP BC          LD A,C:PUSH BC:CALL NORK:POP HL          EXX:LD DE,CALDEC:EXX          LD DE,0:PUSH HL:CALL DECZON2:POP DE          LD HL,CALBIN          LD A,D:CALL BINZON          INC HL          LD A,E:CALL BINZON          CALL INSP_REFRESH          JP INSPMAIN;---------CALC_BUF_CONV LD B,CALCBUFLBUF_CONV      LD A,(HL):CP " ":JR Z,END_CONV              LD (DE),A:INC HL,DE              DJNZ BUF_CONVEND_CONV      XOR A:LD (DE),A              RET;---------INSP_REFRESH LD HL,CALCA,DE,#0101:JP TXTPR;---------------------------------------BINZON  LD B,8BINBIN  RLA:LD C,"1":JR C,BINU:DEC CBINU    LD (HL),C:INC HL:DJNZ BINBIN        RET;---------------------------------------DELIT4P PUSH IX        LD IX,0-1NAZE    OR APBSTH   LD BC,0:INC IX        EX DE,HL:SBC HL,BC:JR C,NDPBSTL   LD BC,0        EX DE,HL:SBC HL,BC:JR NC,PBSTH        DEC DE        LD A,D:INC A:JR NZ,NAZE        LD A,E:INC A:JR NZ,NAZE        INC DE        ADD HL,BC        EX DE,HL        LD BC,(PBSTH+1)ND      ADD HL,BC        EX DE,HL        PUSH IX        POP BC        LD A,C:ADD A,#30        POP IX        RET;-------DECZON2 ;i: HL,Number;          DE',TXT Address to decode        LD BC,10000,(PBSTL+1),BC        LD BC,0,(PBSTH+1),BC        CALL DELIT4P        PUSH HL        EXX:LD (DE),A:INC DE        POP HLDECZ2   LD BC,1000        CALL DELIT        LD (DE),A:INC DEDECZ1   LD BC,100        CALL DELIT        LD (DE),A:INC DEDECZ    LD C,10        CALL DELIT        LD (DE),A:INC DE        LD C,1        CALL DELIT        LD (DE),A:INC DE        RET;-------DELIT   LD A,#FF        OR ADLIT    INC A        SBC HL,BC:JP NC,DLIT        ADD HL,BC,A,#30        RET;---------------------------------------DEDEC   PUSH BC        LD C,EIdec    LD A,(DE):INC E        CP #30:JR C,Ilen        CP #3A:JP C,IdecIlen    LD A,E:SUB C        POP BC:CP 6:JP NC,EDEC        DEC E        PUSH BC        LD BC,DE:DEC C        PUSH HL,DE        LD H,0        DEC A:JR NZ,DEC2        LD A,(BC):SUB #30:LD L,A        JP DECXXDEC2    DEC A:JR NZ,DEC3        LD A,(BC):SUB #30:LD L,A:DEC C        LD A,(BC):SUB #30:JP Z,DECXX        LD B,A:XOR A:ADD A,10:DJNZ $-2        ADD A,L:LD L,A        JP DECXXDEC3    DEC A:JR NZ,DEC4        LD A,(BC):DEC C:SUB #30:LD L,A        LD A,(BC):DEC C:SUB #30:JR Z,D31        LD D,B        LD B,A:XOR A:ADD A,10:DJNZ $-2        LD B,D:ADD A,L:LD L,AD31     LD A,(BC):SUB #30:JP Z,DECXX        LD B,A,DE,100:ADD HL,DE:DJNZ $-1        JP DECXXDEC4    DEC A:JR NZ,DEC5        LD A,(BC):DEC C:SUB #30:LD L,A        LD A,(BC):DEC C:SUB #30:JR Z,D41        LD D,B        LD B,A:XOR A:ADD A,10:DJNZ $-2        LD B,D:ADD A,L:LD L,AD41     LD A,(BC):DEC C:SUB #30:JR Z,D42        PUSH BC        LD B,A,DE,100:ADD HL,DE:DJNZ $-1        POP BCD42     LD A,(BC):SUB #30:JR Z,DECXX        LD DE,1000        LD B,A:ADD HL,DE:DJNZ $-1        JP DECXXDEC5    LD A,(BC):DEC C:SUB #30:LD L,A        LD A,(BC):DEC C:SUB #30:JR Z,D51        LD D,B        LD B,A:XOR A:ADD A,10:DJNZ $-2        LD B,D:ADD A,L:LD L,AD51     LD A,(BC):DEC C:SUB #30:JR Z,D52        PUSH BC        LD B,A,DE,100:ADD HL,DE:DJNZ $-1        POP BCD52     LD A,(BC):DEC C:SUB #30:JR Z,D53        LD DE,1000        PUSH BC        LD B,A:ADD HL,DE:DJNZ $-1        POP BCD53     LD A,(BC):SUB #30:JR Z,DECXX        LD DE,10000        LD B,A:ADD HL,DE:JR C,TEDEC        DJNZ $-3DECXX   LD BC,HL:OR ATEDEC   POP DE,HL        LD (HL),C2B:INC L        LD (HL),C:INC L        LD (HL),B:INC L        POP BC:JP C,EDEC        JP DEE;-------DEHEX   PUSH BC        LD C,E:INC CIhex    LD A,(DE):INC E        CP #30:JR C,InoH        CP #3A:JP C,Ihex        CP #41:JR C,InoH        CP #47:JP C,IhexInoH    LD A,E:SUB C        POP BC:JP Z,EDEC        CP 5:JP NC,EDEC        DEC E        PUSH BC        PUSH HL,DE        LD H,0,BC,#3007        DEC E        DEC A:JR NZ,HEX2        LD A,(DE)        SUB B:CP #0A:JR C,$+3:SUB C        LD L,A        JP HEXXHEX2    DEC A:JR NZ,HEX3        LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        LD L,A        LD A,(DE)        SUB B:CP #0A:JR C,$+3:SUB C        OR A.4      RLA        OR L:LD L,A        JP HEXXHEX3    DEC A:JR NZ,HEX4        LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        LD L,A        LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        OR A.4      RLA        OR L:LD L,A        LD A,(DE)        SUB B:CP #0A:JR C,$+3:SUB C        LD H,A        JP HEXXHEX4    LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        LD L,A        LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        OR A.4      RLA        OR L:LD L,A        LD A,(DE):DEC E        SUB B:CP #0A:JR C,$+3:SUB C        LD H,A        LD A,(DE)        SUB B:CP #0A:JR C,$+3:SUB C        OR A.4      RLA        OR H:LD H,AHEXX    LD BC,HL        POP DE,HL        LD (HL),C2B:INC L        LD (HL),C:INC L        LD (HL),B:INC L        POP BC        JP DEE;-------DEBUX   LD (HL),C2B:INC L        PUSH BC        PUSH HL        EXX:LD A,C:DEC A        EXX:LD C,A,B,0        LD HL,(BUX):ADD HL,BC        LD C,L        LD B,H        POP HL        LD (HL),C:INC L        LD (HL),B:INC L        POP BC        JP DEE;-------DEBIN   LD (DBC),BC        XOR A        LD B,A,C,AIbin    EXA        LD A,(DE)        CP "0":JR Z,Ibin0        CP "1":JR Z,Ibin1        EXA:OR A:JP Z,EDEC        LD (HL),C2B:INC HL        LD (HL),C:INC HL        LD (HL),B:INC HL        LD BC,(DBC)        JP DEEIbin1   SCFIbin0   RL C,B:INC E        EXA:INC A:CP 16+1:JP NC,EDEC        JP Ibin;-------DECHR   LD (DBC),BC        LD A,(DE):INC E:OR A:JR Z,ECHR        LD B,A        LD A,(DE):INC E:CP #22:JR Z,CH1B        OR A:JR Z,ECHR        LD C,A        LD A,(DE):INC E:CP #22:JR Z,CH2BEDEC    LD A,24:OR A:SCF:RETECHR    LD A,27:OR A:SCF:RETCH1B    LD C,B,B,0CH2B    LD (HL),C2B:INC HL        LD (HL),C:INC HL        LD (HL),B:INC HL        LD BC,(DBC)        JP DEE;-------DECODER ;i:  DE,Exp;           BC',$ delta+1;         (BUX),$;;        o:  BC,Result;             C - Err;             Z - Ok;            NZ - Exp2Queue        XOR A        LD HL,BUF2        LD (BUF2A),HL        LD (BUF2I),A        LD (HL),A        LD HL,CBUF        LD BC,CBUF1+1DEE     LD A,(DE):INC E        CP #22:JR Z,DECHR;"        CP "%":JP Z,DEBIN;CP "$":JP Z,DEBUX        CP "#":JP Z,DEHEX        CP #30:JP C,DEA        CP #3A:JP C,DEDECDEA     CP "(":JP Z,BRO        CP "+":JP Z,PLUS        CP "-":JP Z,MINUS        CP "*":JP Z,MUL        CP "/":JP Z,DIV        CP "\":JP Z,MOD        CP "[":JP Z,HI        CP "]":JP Z,LO        CP ")":JR Z,BRC        OR A:JP Z,GOCALC;Constant Decoding;    not ok:$#%"(;        ok:+-*/\[])        PUSH BC        LD BC,(BUF2A)CONST   LD (BC),A:INC C        LD A,(DE):INC E        CP "$":JR Z,SERP        CP "#":JR Z,SERP        CP "%":JR Z,SERP        CP #22:JR Z,SERP        CP "(":JR Z,SERP        CP "+":JR Z,COT        CP "-":JR Z,COT        CP "*":JR Z,COT        CP "/":JR Z,COT        CP "\":JR Z,COT        CP "[":JR Z,COT        CP "]":JR Z,COT        CP ")":JR Z,COT        OR A:JP NZ,CONSTCOT     XOR A:LD (BC),A:INC C        LD (BUF2A),BC:DEC E        LD A,(BUF2I):INC A        LD (BUF2I),A        LD (HL),CLA:INC L        LD (HL),A:INC L        LD (HL),0:INC L        POP BC        JP DEESERP    POP BC:LD A,22:OR A:SCF:RETSER     LD A,22:OR A:SCF:RETBRO     LD (BC),A:INC C:JP DEEBRC     DEC C:LD A,(BC):JR Z,BRE        CP "(":JR Z,BRG        LD (HL),A:INC L        JP BRCBRG     JP DEEBRE     LD A,23:OR A:SCF:RET;-------Padd    INC C:JP PADDPLUS    DEC C:JR Z,Padd        LD A,(BC)        CP CP1:JR Z,PSWP        CP CP2:JR Z,PSWP        CP CP3:JR Z,PFSW        CP CP4:JR Z,PFSW        CP CP5:JR Z,PFSW        CP CP6:JR Z,PFSW        CP CP7:JR Z,PFSW        CP "(":JR Z,Padd        JP SERPSWP    LD (HL),A:INC LPADD    LD A,CP1,(BC),A:INC C:JP DEEPFSW    LD (HL),A:INC L        DEC C:JR Z,Padd        LD A,(BC):CP "(":JR Z,Padd        JP PFSW;-------Madd    INC C:JP MADDMINUS   DEC C:JR Z,Madd        LD A,(BC)        CP CP1:JR Z,MSWP        CP CP2:JR Z,MSWP        CP CP3:JR Z,MFSW        CP CP4:JR Z,MFSW        CP CP5:JR Z,MFSW        CP CP6:JR Z,MFSW        CP CP7:JR Z,MFSW        CP "(":JR Z,Madd        JP SERMSWP    LD (HL),A:INC LMADD    LD A,CP2,(BC),A:INC C:JP DEEMFSW    LD (HL),A:INC L        DEC C:JR Z,Madd        LD A,(BC):CP "(":JR Z,Madd        JP MFSW;-------MULadd  INC C:JP MULADDMUL     DEC C:JR Z,MULadd        LD A,(BC)        CP CP3:JR Z,MULSWP        CP CP4:JR Z,MULSWP        CP CP5:JR Z,MULSWP        CP CP1:JR Z,MULadd        CP CP2:JR Z,MULadd        CP CP6:JR Z,MULFSW        CP CP7:JR Z,MULFSW        CP "(":JR Z,MULadd        JP SERMULSWP  LD (HL),A:INC LMULADD  LD A,CP3,(BC),A:INC C:JP DEEMULFSW  LD (HL),A:INC L        DEC C:JR Z,MULadd        LD A,(BC);"("        CP CP3:JR Z,MULFSW        CP CP4:JR Z,MULFSW        CP CP5:JR Z,MULFSW        CP CP6:JR Z,MULFSW        CP CP7:JR Z,MULFSW        JP MULadd;-------DIVadd  INC C:JP DIVADDDIV     DEC C:JR Z,DIVadd        LD A,(BC)        CP CP3:JR Z,DIVSWP        CP CP4:JR Z,DIVSWP        CP CP5:JR Z,DIVSWP        CP CP1:JR Z,DIVadd        CP CP2:JR Z,DIVadd        CP CP6:JR Z,DIVFSW        CP CP7:JR Z,DIVFSW        CP "(":JR Z,DIVadd        JP SERDIVSWP  LD (HL),A:INC LDIVADD  LD A,CP4,(BC),A:INC C:JP DEEDIVFSW  LD (HL),A:INC L        DEC C:JR Z,DIVadd        LD A,(BC);"("        CP CP3:JR Z,DIVFSW        CP CP4:JR Z,DIVFSW        CP CP5:JR Z,DIVFSW        CP CP6:JR Z,DIVFSW        CP CP7:JR Z,DIVFSW        JP DIVadd;-------MOD     JP DEE;-------HIadd   INC C:JP HIADDHI      DEC C:JR Z,HIadd        LD A,(BC)        CP CP3:JR Z,HIadd        CP CP4:JR Z,HIadd        CP CP5:JR Z,HIadd        CP CP1:JR Z,HIadd        CP CP2:JR Z,HIadd        CP "(":JR Z,HIadd        JP SERHIADD   LD A,CP6,(BC),A:INC C:JP DEE;-------LOadd   INC C:JP LOADDLO      DEC C:JR Z,LOadd        LD A,(BC)        CP CP3:JR Z,LOadd        CP CP4:JR Z,LOadd        CP CP5:JR Z,LOadd        CP CP1:JR Z,LOadd        CP CP2:JR Z,LOadd        CP "(":JR Z,LOadd        JP SERLOADD   LD A,CP7,(BC),A:INC C:JP DEE;---------------------------------------NOPOLSK LD A,#FF:OR A:RET;-------GOCALC  DEC C:LD A,(BC):JR Z,STP        LD (HL),A:INC L        JP GOCALCSTP     LD (HL),0,A,(BUF2):OR A:JR NZ,NOPOLSK        EXX:PUSH DE,BC        EXX:LD L,0:CALL POLSK        EXX:POP BC,DE        EXX        RET;-------CPEND   POP BC        DI:LD SP,(DSP)        XOR A        RETCPHI    EXX        POP HL:LD L,H,H,0        PUSH HL        EXX        JP POLCPLO    EXX        POP HL:LD H,0        PUSH HL        EXX        JP POLPOLSK   DI:LD (DSP),SP,SP,SPSAFEPOL     LD A,(HL):INC HL        CP C2B:JR NZ,LSK        LD C,(HL):INC HL        LD B,(HL):INC HL        PUSH BC        JP POLLSK     CP CP1:JR Z,CPPLS        CP CP2:JR Z,CPMNS        CP CP3:JR Z,CPMUL        CP CP4:JR Z,CPDIV;CP CP5 JR Z CPMOD        CP CP6:JR Z,CPHI        CP CP7:JR Z,CPLO        OR A:JR Z,CPEND        DI:LD SP,(DSP)        LD A,25:OR A:SCF        RET;-------CPPLS   EXX        POP BC        POP HL        ADD HL,BC        PUSH HL:EXX:JP POLCPMNS   EXX        POP BC        POP HL        OR A:SBC HL,BC        PUSH HL:EXX:JP POLCPMUL   EXX        POP DE        POP BC        LD HL,0        LD A,16Mul16   ADD HL,HL:RL E,D:JP NC,NoMul16        ADD HL,BC:JP NC,NoMul16        INC DENoMul16 DEC A:JP NZ,Mul16        PUSH HL:EXX:JP POLCPDIV   EXX        POP BC        POP HL        LD A,B        OR A:JR NZ,DIVBIG        OR C:JR Z,EDIV        XOR A        LD B,16Div8    ADD HL,HL:RLA        CP C:JP C,Div8Nxt        SUB C:INC LDiv8Nxt DJNZ Div8        PUSH HL:EXX:JP POLDIVBIG  LD DE,0-1        OR APDIV    SBC HL,BC:INC DE:JR C,Pdiv        JP PDIVPdiv    PUSH DE:EXX:JP POLEDIV    EXX:LD A,26:OR A:SCF        RETCPMOD   EXX        EXX        JP POL;---------------------------------------SEARCHNEXT JR GOsrh7SEARCH  PUSH IX        LD IX,SRHWND:CALL PRWOW        LD C,0        CALL STRBULL:JR Z,SRHZERO        INC DE:LD C,ESRHZERO EXX:LD HL,STRBUFFL:EXX        LD HL,STRBUFF,DE,#0101,B,#28,A,#FD:CALL ISTRSRHMAIN EI:HALT        CALL ENKE:JR NZ,GOSRH7        CALL ESC:JR NZ,SRHEXIT        XOR A:CALL ISTR        LD A,2:CALL ISTR        JR SRHMAINSRHEXIT CALL RRESB        POP IX        XOR A        RETGOSRH7  CALL RRESB:POP IXGOsrh7  CALL STRBULL:RET Z        CALL PRTOBACK        CALL GOSRH:JR NC,COMEBACK        CALL SCRM13U        PUSH BC:CALL C,INCCUR        LD HL,LHLCR,DE,PGHLP,BC,3:LDIR        LD A,(IX+5):SUB LNZ+1+LNZ2:SRL A        LD B,ASRHGE   PUSH BC:CALL PGMUZ        POP BC:JR NC,SRHge        DJNZ SRHGESRHge   POP AF        LD (CRX),A:CALL CRMFWDSRHET   CALL REFRESH        XOR A        RETCOMEBACK PUSH IX         LD IX,NFNDWND:CALL PRWOW         LD HL,DHLA,DE,LHLCR,BC,3:LDIR         LD HL,RHLCR2,DE,RHLCR,C,3:LDIR         CALL TOWORK         CALL USPO         CALL NUSP         CALL RRESB         POP IX         JR SRHETPRTOBACK PUSH DE         CALL RCRTD         CALL INCRCR         LD HL,LHLCR,DE,DHLA,BC,3:LDIR         LD HL,RHLCR,DE,SHLA,C,3:LDIR         LD BC,(SHLA+2)         LD A,PGM:SUB C         LD BC,(SHLA)         LD HL,#4000:OR A:SBC HL,BC         LD BC,HL         CALL YORGE         LD (LHLB),HL         LD (LHLB+2),DE         CALL DCRTR         POP DE         RET;-------SRHDZT    LD DE,#3FFF:JP SRHZZTSRHFAST   LD A,(RHLCR+2):INC A          CP PGM+1:JR NC,SRHDZT          LD (RHLCR+2),A          PUSH BC:CALL MNGCVPL          POP BC          SET 7,D          SET 6,D          JP SRHFASTB;-------GOSRH     INC DE:LD HL,STRBUFF:ADD HL,DE:LD (HL),0,(STRBUFA),HL          LD A,(LHLCR+2):CALL MNG0VPL          LD A,(RHLCR+2):CALL MNGCVPL          LD BC,(LHLCR)          LD DE,(RHLCR)          SET 7,D          SET 6,DSRHFRST   LD HL,STRBUFFSRH13DD   LD A,(HL):OR A:JR Z,SRHFOUND          INC DE:BIT 7,D:JR Z,SRHFASTSRHFASTB  LD A,(DE),(BC),A:CP (HL):JR Z,SRHNXT          LD HL,STRBUFFSRHNXTB   INC BC:BIT 6,B:JR NZ,SRHFAST2SRHFAST2B CP #0D+1:JP NC,SRH13DD          JP SRHFRSTSRHNXT    INC HL:JP SRHNXTBSRHFOUND  SCFSRHZZT    LD HL,(STRBUFA),(HL)," "          LD (LHLCR),BC          RES 7,D          RES 6,D          LD (RHLCR),DE          RET;-------SRHFAST2  PUSH AF          LD A,B:AND %00111111:LD B,A          LD A,(LHLCR+2):INC A          LD (LHLCR+2),A          PUSH BC:CALL MNG0VPL          POP BC          POP AF          JP SRHFAST2B;-------STRBULL LD DE,STRBUFFL-1        LD HL,STRBUFF+STRBUFFL-1STRSTRS LD A,(HL):CP " ":RET NZ        DEC HL,DE:LD A,D:OR E:JP NZ,STRSTRSSTRSTR  XOR A        RET;---------------------------------------F1MENU  PUSH IX        LD IX,F1WND:CALL PRWOW        CALL USPO        CALL NUSP        CALL RRESB        POP IX        RET;---------------------------------------COPY    LD A,(MARKED):OR A:JR Z,NOCOPY        CALL COPYXNOCOPY  CALL REFRESH        XOR A        RETCOPYX   LD A,1:CALL MNGC_PL        LD A,(BHLBLK+2):CALL MNG0VPL        LD HL,(BHLBLK)        LD DE,#C000COPYPG  LD BC,(EHLBLK+2)        LD A,(BHLBLK+2)        CP C:JR Z,COPYBTE,NC,COPYENDCOPYBTE LD A,(EHLBLK+1)        CP H:JR Z,COPYCHE,C,COPYENDCOPYbte LDI        LD A,H:CP #40:JR NC,COPYINCPG        LD A,D:CP #C0:JR C,COPYERR        JP COPYBTECOPYCHE LD A,(EHLBLK)        CP L:JR Z,COPYEND,NC,COPYbteCOPYEND LD A,D:AND %00111111:LD D,A:JR COPYendCOPYERR LD DE,0COPYend LD (CLIPSZ),DE        RETCOPYINCPG LD A,H:AND %00111111:LD H,A          LD A,(BHLBLK+2):INC A          LD (BHLBLK+2),A          PUSH HL,DE:CALL MNG0VPL          POP DE,HL          JP COPYPG;---------------------------------------CUT     LD A,(MARKED):OR A:RET Z        CALL COPYX        CALL MARK_KILL        JP Bspc;---------------------------------------PASTE   LD HL,(CLIPSZ),A,H:OR L:RET Z        CALL MARK_KILL        LD A,1:CALL MNGC_PL        LD HL,#C000PASTEBT LD A,(HL):INC HL        PUSH HL:CALL INCLCR        POP HL:JR NC,PASTERR        LD A,(CLIPSZ+1):OR #C0:CP H:JR Z,$+4,NC,PASTEBT        LD A,(CLIPSZ):CP L:JR Z,PASTEND,NC,PASTEBTPASTERRPASTEND CALL REFRESH        LD A,(CRFLG):OR A:CALL Z,PASTEGG        LD A,(CRP),(CRX),A        CALL CHA        XOR A        RETPASTEGG  LD HL,LHLCR,DE,PGHLP,BC,3:LDIR         LD A,(IX+5):SUB LNZ+1+LNZ2         LD B,AGPASTEPG PUSH BC:CALL PGMUZ         POP BC:JR NC,GPAGG         DJNZ GPASTEPGGPAGG    JP REFRESH;---------------------------------------QSAVE   PUSH IX        LD IX,SVWND:CALL PRWOW        CALL PRTOSV        LD (DAHL),HL        LD (DADE),DE        LD HL,FLLOAD,(HL),#00        CALL DELFL:JR Z,NFER        LD HL,(DAHL),(FLMAKE+1+0),HL        LD HL,(DADE),(FLMAKE+1+2),HL        LD HL,FLMAKE,(HL),#00        CALL MKFILE:JR NZ,MKER        CALL SAVEDAT        LD A,3,(ESTA),A        XOR A:LD (CHANGES),ABTZF    CALL TOWORK        CALL RRESB        POP IX        CALL REFRESH        XOR A        RET;-------NFERMKER    PUSH IX        LD IX,ERWND:CALL PRWOW        CALL USPO        CALL NUSP        CALL RRESB        POP IX        JR BTZF;---------------------------------------SAVEDAT LD A,PGZ,(SVD+1),ASVD     LD A,0        CALL MNGCVPL        LD HL,SVD+1:INC (HL)        LD HL,#C000,B,32:CALL SAVE512        CP #0F:RET Z        LD BC,(DHLA+2):INC C        LD A,(SVD+1):CP C:RET NC        JP SVD;---------------------------------------MNGC_PL EXA:LD A,0:JP WLDMNG0_PL EXA:LD A,78:JP WLDMNG8_PL EXA:LD A,79:JP WLDPRWOW   LD A,1:JP WLDRRESB   LD A,2:JP WLDPRSRW   LD A,3:JP WLDPRIAT   EXA:LD A,4:JP WLDGADRW   LD A,5:JP WLDCURSOR  LD A,6:JP WLDCURSER  LD A,7:JP WLDYN      EXA:LD A,8:JP WLDISTR    EXA:LD A,9:JP WLDNORK    EXA:LD A,10:JP WLDTXTPR   LD A,11:JP WLDDMAPL   EXA:LD A,13:JP WLDGEDPL   LD A,15:JP WLD;-------KBSCN   EXA:LD A,42:JP WLDSPKE    LD A,16:JP WLDUPPP    LD A,17:JP WLDDWWW    LD A,18:JP WLDLFFF    LD A,19:JP WLDRGGG    LD A,20:JP WLDTABK    LD A,21:JP WLDENKE    LD A,22:JP WLDBSPC    LD A,24:JP WLDPGUP    LD A,25:JP WLDPGDN    LD A,26:JP WLDDEL     LD A,43:JP WLDESC     LD A,23:JP WLDHOME    LD A,27:JP WLDEND     LD A,28:JP WLDF1      LD A,29:JP WLDF5      LD A,33:JP WLDF10     LD A,38:JP WLDALT     LD A,39:JP WLDSHIFT   LD A,40:JP WLDCTRL    LD A,41:JP WLDUSPO    LD A,46:JP WLDNUSP    LD A,47:JP WLD;-------LOAD512 LD A,48:JP WLDLOAD256 LD A,60:JP WLDLOADNON LD A,61:JP WLDSAVE512 LD A,49:JP WLDFENTRY  LD A,59:JP WLDGFILE   LD A,62:JP WLDMKFILE  LD A,72:JP WLDDELFL   LD A,75:JP WLD;-------MNGV_PL EXA:LD A,64:JP WLDMNGCVPL EXA:LD A,65:JP WLDMNG0VPL EXA:LD A,80:JP WLDGVmod   EXA:LD A,66:JP WLDGYoff   LD A,67:JP WLDGXoff   LD A,68:JP WLD;---------------------------------------PLWND   DB 5,0        DB 0,0;      X,Y        DB 80,0;     W,H        DB %00010111;PAPER+INK        DB 0        DW #0; BUFFER        DB 0,0;LINES        DB 1,5;        CURnow,CURmax        DB %11110001,0;CURcolor        DW TAPT        DW TAPB        DW 0;-------TAPT    DB #8,#1        DB "File:                                   "        DB "                                        "        DB 0TAPB    DB #8,#1        DB " F1 - HELP page                         "        DB "                                        "        DB 0;-------SVWND   DB 4+128,0        DB 29,13;    X,Y        DB 20+2,1+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0; BUFFER        DB 0,0;LINES        DW 0        DW 0        DW SAVINGMSAVINGM DB #E,"Saving...",0;-------WMWND   DB 4+128,0        DB 21,12;    X,Y        DB 40+2,4+2; W,H        DB %01111111;PAPER+INK        DB 0        DW #0; BUFFER        DB 2,0;LINES        DW WARNING        DW 0        DW 0WARNING DB #9,#E,"WARNING!",0;-------ERWND   DB 4+128,0        DB 21,13;    X,Y        DB 40+2,2+2; W,H        DB %00111111;PAPER+INK        DB 0        DW #0; BUFFER        DB 0,0;LINES        DW ERT        DW ERB        DW 0ERT     DB #9,#E,"ERROR:",0ERB     DB #9,#E,"press any key",0;-------ME01    DB #0E,"Save changes?",0;-------SRHWND  DB 4+128,0        DB 21,11;    X,Y        DB 40+2,1+2; W,H        DB SRHWNDC;PAPER+INK        DB 0        DW #0; BUFFER        DB 0,0;LINES        DW SRHT        DW 0        DW 0SRHT    DB #9,#E,"SEARCH:",0;-------NFNDWND DB 4+128,0        DB 26,13;    X,Y        DB 30+2,1+2; W,H        DB NFNWNDC;PAPER+INK        DB 0        DW #0; BUFFER        DB 0,0;LINES        DW 0        DW 0        DW NFNDNFND    DB #E,"Not found!!!",0;-------CALCWND DB 4,0        DB 54,16        DB 24+2,7+2        DB CLCWNDC        DB 0        DW #0        DB 6,3        DW CALCT        DW 0        DW CALCACALCT   DB #9,#E,"Inspector:",0CALCA   DB 13        DB 13        DB " DEC:"CALDEC  DB "00000"        DB "    HEX:#"CALHEX  DB "0000",13        DB " BIN:%"CALBIN  DB "00000000 00000000",13        DB 13        DB " DATA: FFFFFFFFFFFFFFFF",0;-------F1WND   DB 4+128,0        DB 8,4        DB 64,16        DB %01111111        DB 0        DW #0        DB 0,0        DW F1T        DW F1B        DW F1AF1T     DB #9,#E,"TEXT Editor HELP Page",0F1B     DB #9,#E,"PRESS any key to CLOSE this Window",0F1A     DB "Controls:",#D        DB 1,"ESC - Exit (выход)",#D        DB #D        DB 1,"ctrl+S - Save changes (сохранить изменения)",#D        DB 1,"ctrl+F - Find Text (поиск текста)",#D        DB 1,"ctrl+G - Find Next (искать дальше)",#D        DB 1,"ctrl+HOME - GO to File Start (перейти в начало файла)",#D        DB 1,"ctrl+END - GO to File End (перейти в конец файла)",#D        DB #D        DB 1,"ctrl+SHIFT - ENG/RUS (выбор языка ввода)",#D        DB #D        DB "Other Controls:",#D        DB 1,"pgUP,pgDN,HOME,END,DELETE,BSPACE,INSERT,CAPSLOCK",#D        NOP;---------------------------------------ESTA    NOP; ExitStateCHANGES NOP; !=0 if text changedMARKED  NOP; =1 if marked block is active (another print page proc)REFFLG  NOP;File-sizeDAHL    DS 2; LowDADE    DS 2; High;LoadingAPG     NOP ; Active PageLHLA    DS 4; LenghtLHLB    DS 4SHLA    DS 3; Source Position [Offset(2)+Page(1)]DHLA    DS 3; Dest. Position  [Offset(2)+Page(1)];TXT-editingCRX     NOP ; CURSOR X representationCRY     NOP ; CURSOR Y representationCRXX    DS 2; ColCRYY    DS 2; LnXY      DS 2; temp. XY (uses in Line Print)INOV    NOP ; 0-INS, 1-OVERLHLCR   DS 3; Left Cursor Position [Offset(2)+Page(1)]RHLCR   DS 3; Right Cursor Position [Offset(2)+Page(1)]LHLCR2  DS 3RHLCR2  DS 3PGHLP   DS 3; TXT Page Start Address [Offset(2)+Page(1)]LNHLP   DS 3; TXT Line --//--LNTMP   DS 3; Temp For MarkBHLBLK  DS 3; Block Begin Address [Offset(2)+Page(1)]EHLBLK  DS 3; Block End Address [--//--]CLIPSZ  DW 0; Clipboard size;CursorCRPOZ   DS 2; Address on Screen (Line Print)CRP     DS 2; Cursor Address on Screen (REFRESH)CRFLG   NOP ; =0 if Cursor Out of Screen (REFRESH);SearchSTRBUFA  DW 0;         Address of stop tokenSTRBUFF  DS 40," ";    Searching stringSTRBUFFL EQU $-STRBUFF;String Size         NOP;InspectorCALCBUF  DS 40," "CALCBUFL EQU $-CALCBUF         NOP;CalcBUX      DS 2DBC      DS 2DSP      DS 2BUF2A    DS 2;Const bufBUF2I    NOP ;Index;---------------------------------------ENDPL;---------------------------------------;---------------------------------------