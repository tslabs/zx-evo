;---------------------------------------;PS/2 HANDLER (STAND-ALONE);(C) KOSHI/MGN/2018;---------------------------------------RPT     EQU 25;AUTO REPEATSCANS   EQU 51;SCANCODES;-------TAB4E   LD HL,(TAB+#00):LD A,H:OR L        LD HL,(TAB+#02):OR H,L        LD HL,(TAB+#04):OR H,L        LD HL,(TAB+#06):OR H,L        LD HL,(TAB+#08):OR H,L        LD HL,(TAB+#0A):OR H,L        LD HL,(TAB+#0C):OR H,L        LD HL,(TAB+#0E):OR H,L        LD HL,(TAB+#10):OR H,L        LD HL,(TAB+#12):OR H,L        RET;-------ISTR    ;i:A=#FF init0:;             i: HL - Address of string;                            (on screen);                 D - CURMAX;                 E - CURNOW;          A=#01 terminate:;             o: HL - Address of string;          A=#00 input(CALL every frame);;          A=#FD init2:;             i: HL - Address of string;                 D - Y (in window);                 E - X (in window);                 B - CURMAX;                 C - CURNOW;                HL'- buffer size;          A=#02 window REFRESH (on SCR);;          A=#FE init info position:;                 H - 0=top, 1=bottom;                 L - reserved;          A=#03 info refresh;;          A=#FC CAPS, INS, CTRL+SHIFT;             i:none;             o: A - state:;                     [7]: %0 - INS;                          %1 - OVR;                     [6]: %0 - CAPS off;                          %1 - CAPS on;                   [5-2]:reserved;                   [1-0]:%00 - ENG;                         %01 - RUS;                         %10 - reserved;                         %11 - reserved        INC A:JP Z,IINIT        INC A:JP Z,IINIF        INC A:JP Z,IINI2        INC A:JP Z,FCREF        CP #01+4:JP Z,IEXIT        CP #02+4:JP Z,IWRFR        CP #03+4:JP Z,IREFR        CALL BSPC,NZ,IBS; Backspace        CALL DELE,NZ,IDL; Delete        CALL RGGG,NZ,IRG; Right Arrow        CALL LFFF,NZ,ILF; Left Arrow        CALL INS,NZ,INSOVR        CALL LNGCHE        CALL CAPSCHE        CALL CLAvA:RET Z;-------SMBADD  CALL ICPO        LD C,A        LD A,(INOV):OR A:JR NZ,IZIMOD        PUSH HL,BC        CALL ILNG:JR Z,LSIS        ADD HL,BC:DEC HL        LD DE,HL:INC DE:LDDRLSIS    POP BC,HLIZIMOD  LD (HL),C;-------IRG     LD BC,(ICUP)        LD A,C:INC A        CP B:JR NC,IRGW        CALL IRCU        LD (ICUP),A        JP ICURIRGW    LD HL,(IBSZ)        LD DE,(ICUP),E,D,D,0        OR A:SBC HL,DE:RET Z,C        EX DE,HL        LD HL,(IWOF)        SBC HL,DE:RET NC        ADD HL,DE:INC HL        LD (IWOF),HL        XOR A        RETILF     LD BC,(ICUP)        LD A,C:DEC A        CP B:JR NC,ILFW        CALL IRCU        LD (ICUP),A        JP ICURILFW    LD HL,(IWOF):LD A,H:OR L:RET Z        DEC HL:LD (IWOF),HL        RET;-------IBS     CALL ILF:RET Z        CALL ICPO        LD A,(INOV):OR A:JR Z,BSINSBSYO    LD (HL),32        RETBSINS   EX DE,HL        LD HL,DE:INC HL        CALL ILNG:LDIR        EX DE,HL        JR BSYO;-------IDL     CALL ICPO        EX DE,HL        LD HL,(IBSZ),BC,(ISAD):ADD HL,BC        EX DE,HL:INC HL        OR A:SBC HL,DE        EXA:ADD HL,DE:DEC HL        EXA:JR NC,BSYO        JR BSINS;-------IINIT   LD (ISAD),HL        LD (ICUP),DE        LD HL,0        LD (IWOF),HL        LD L,D        LD (IBSZ),HL        XOR A:LD (ICRF+1),A        JP ICURIEXIT   ;XOR A:LD (LANG),A        CALL IRCU        LD HL,(ISAD)        RET;-------IINI2   LD (ISAD),HL        LD (ICUP),BC        LD (IWAD),DE        EXX        LD A,H:OR A:JR NZ,UPSZ        LD A,(ICUP+1):CP L:JR C,UPSZ        LD L,AUPSZ    LD (IBSZ),HL        LD HL,0        LD (IWOF),HL        LD A,1,(ICRF+1),A;-------ICURIRCU    PUSH AFICRF    LD A,0:OR A        CALL Z,ICPC,NZ,ICCC        SET 7,L:LD A,(HL):RRD        POP AF        RETICCC    CALL GPOZA        LD BC,(IWAD)        LD A,H:ADD A,B:LD H,A        LD A,L:ADD A,C:LD L,A        LD BC,(ICUP),B,0:ADD HL,BC        RETICPC    LD HL,(ISAD)        LD BC,(ICUP),B,0:ADD HL,BC        CP A        RET;-------ICPO    LD HL,(ISAD)        LD BC,(ICUP),B,0:ADD HL,BC        LD BC,(IWOF):ADD HL,BC        RETILNG    PUSH HL        LD HL,(IBSZ)        LD BC,(ICUP),B,0:INC C        OR A:SBC HL,BC        LD BC,(IWOF)        OR A:SBC HL,BC        LD BC,HL        POP HL        RET;-------LNGCHE  CALL CTRL:RET Z        CALL SHIFT:RET Z        LD A,(LANG):XOR 1        LD (LANG),A        JP USPO;-------CAPSCHE CALL CAPS:RET Z        LD BC,#DFF7,A,#0C:OUT A        LD B,#BF        LD A,(CLST):XOR 1        LD (CLST),A        SLA A:OUT A        RET;-------INSOVR  LD A,(INOV):XOR 1        LD (INOV),A        RET;-------IINIF   XOR A:DEC H:JR NZ,IINIf        LD A,(IX+5):DEC AIINIf   LD H,A,(IISP),HL        RETIREFR   LD A,(LANG):OR A        LD HL,ISI1:JR Z,$+5:LD HL,ISI2        LD DE,ISIL,BC,3:LDIR        LD A,(INOV):OR A        LD HL,ISI3:JR Z,$+5:LD HL,ISI4        LD DE,ISII,BC,3:LDIR        LD A,(CLST):OR A        LD HL,ISI5:JR Z,$+5:LD HL,ISI6        LD DE,ISIC,BC,3:LDIR        LD HL,ISINF,DE,(IISP):JP TXTPR;-------IWRFR   LD HL,(ISAD)        LD BC,(IWOF):ADD HL,BC        LD DE,(IWAD)        LD A,(ICUP+1),B,0,C,A:CALL PRSRW        RET;-------FCREF   CALL INS,NZ,INSOVR        CALL LNGCHE        CALL CAPSCHE        LD A,(LANG):AND %00000011        LD C,A        LD A,(INOV)        OR A:JR Z,$+4:SET 7,C        LD A,(CLST)        OR A:JR Z,$+4:SET 6,C        LD A,C        RET;---------------------------------------CLAvA   ;i:none;        o: Z - no chars;           A - char [a-z/A-Z;0-9];                    [†-Ô/Ä-ü;0-9];               also see TAIE1,TAIE2;                        TAIR1,TAIR2        LD HL,TAB+13        LD A,(HL):INC HL:OR A:JR Z,$-3        CP #FF:RET Z        CALL ARL:RET Z:LD A,(HL)        LD HL,TAI0,B,SCANSAvA     CP (HL):JR Z,CLA:INC HL        DJNZ AvA        XOR A        RETCLA     LD BC,0-TAI0:ADD HL,BC        XOR A:LD (CLTT),A        LD A,(CLST):OR A:JR NZ,SHITNOSHI   LD A,(LANG)        LD BC,TAIE1        OR A:JR Z,$+5:LD BC,TAIR1        ADD HL,BC        PUSH HL:CALL SHIFT        POP HL:LD C,0:JR Z,$+3:INC C        LD A,(CLTT):XOR C:JR Z,NOSH        LD BC,SCANS:ADD HL,BCNOSH    LD A,(HL)        OR A        RET;-------SHIT    LD A,(LANG)        LD BC,TAIE0        OR A:JR Z,$+5:LD BC,TAIR0        CALL TAIZ:JR NZ,NOSHI        LD A,1,(CLTT),A        JR NOSHI;-------TAIZ    LD A,(BC):INC BC        CP #FF:RET Z        CP L:JR NZ,TAIZ        INC A        RET;---------------------------------------CLAVA   ;i:none;        o: Z - no chars;           A - char [a-z;0-9];               also see TAIE1 table        CALL ART:RET Z        LD HL,TAI0,B,SCANSAVA     CP (HL):JR Z,ClA:INC HL        DJNZ AVA        XOR A        RETClA     LD BC,SCANS:ADD HL,BC        LD A,(HL):OR A        RET;---------------------------------------NUSP    EI:HALT        CALL ANYK:RET NZ        JR NUSPUSPO    EI:HALT        CALL ANYK:RET Z        JR USPO;---------------------------------------UPPP    LD HL,BUP:JP ARC;UPDWWW    LD HL,BDN:JP ARC;DOWNLFFF    LD HL,BLF:JP ARC;LEFTRGGG    LD HL,BRG:JP ARC;RIGHTPGU     LD HL,BPU:JP ARC;pgUPPGD     LD HL,BPD:JP ARC;pgDNENKE    LD A,#5A:JP ARL; ENTERSPKE    LD A,#29:JP ARL; SPACEBSPC    LD A,#66:JP ARL; BACKSPACEHOME    LD A,#6C:JP ARL; HOMEEND     LD A,#69:JP ARL; ENDDELE    LD A,#71:JP ARL; DELETEINS     LD A,#70:JP ARL; INSERTESC     LD A,#76:JP AR2F1      LD A,#05:JP AR2F2      LD A,#06:JP AR2F3      LD A,#04:JP AR2F4      LD A,#0C:JP AR2F5      LD A,#03:JP AR2F6      LD A,#0B:JP AR2F7      LD A,#83:JP AR2F8      LD A,#0A:JP AR2F9      LD A,#01:JP AR2F10     LD A,#09:JP AR2CAPS    LD HL,BCA:JP ARC;CAPS LOCKALT     LD HL,BHM:JP ARGSHIFT   LD HL,BCS:JP ARGCTRL    LD HL,BSS:JP ARGTABK    LD HL,TAB:JP ARCENK2    LD A,#5A,HL,TAB+13:JR IIESC2    LD A,#76,HL,TAB+4II      CP (HL):JR NZ,ArL        JR AC;-------AR2     LD HL,TAB+4        CP (HL):JR Z,ARCArL     XOR A        RET;-------ART     LD HL,TAB+13        LD A,(HL):INC HL:OR A:JR Z,$-3        LD (ART+1),HL        DEC HL:CP #FF:JR Z,BKZARc     LD A,(HL):OR A:RET Z        LD A,(ARK):CP (HL):JR NZ,ACZ        LD A,(ARR)        OR A:JR Z,ACZ        CP #FF:JR NZ,ArCZ        LD A,RPT,(ARR),AACZ     LD A,(HL)        OR A        RETArCZ    XOR A        RETBKZ     LD HL,TAB+13,(ART+1),HL:RET;-------ARL     LD HL,TAB+13,BC,7        CPIR:JR NZ,ArL:DEC HL;-------ARC     LD A,(HL):OR A:RET Z        LD A,(ARK):CP (HL):JR NZ,ArC        LD A,(ARR)        OR A:JR Z,AC        CP #FF:JR NZ,ArC        LD A,RPT,(ARR),AAC      LD A,1:OR A        RETArC     XOR A        RET;-------ARG     LD A,(HL):OR A:RET Z        JR AC;-------ANYK    LD HL,TAB,B,20_XOR A:CP (HL):JR NZ,NYK:INC HL:DJNZ $-4        RETNYK     LD A,RPT,(ARR),A        RET;---------------------------------------ALM     LD HL,TAB+13,BC,7        CPIR:RET Z        LD E,A        XOR A        LD HL,TAB+13,BC,7        CPIR:RET NZ:DEC HL        LD (HL),E        LD (IX+24),E        LD (IX+23),#FF        RET;---------------------------------------OVER    LD BC,#DFF7,A,#0C:OUT A        LD BC,#BFF7,A,#01:OUT A        LD BC,#DFF7,A,#F0:OUT A        XOR A        LD (E0F),A        LD HL,TAB        LD B,20,(HL),A:INC HL:DJNZ $-2        LD A,1:OR A        RETK9      LD (BHM),A        RET;---------------------------------------E0Psd   LD (E0F),A:JR Psd;GET SCAN CODE:PSD2    LD IX,TAB        LD A,(IX+23)        OR A:JR Z,PSD        CP #FF:JR Z,PSD        DEC (IX+23)PSD     LD BC,#DFF7,A,#F0:OUT A        LD BC,#BFF7Psd     IN A        OR A:RET Z        CP #E0:JR Z,E0Psd        CP #F0:JP Z,KOF        CP #FF:JR Z,OVERBAT     JP Z,KoF;JP/JP Z,;-------        LD C,A        LD A,(E0F):OR A:LD (IX+25),0        LD A,C:JR Z,NOe0        CP #12:RET Z        CP #59:RET ZNOe0    CP #12:JR Z,K2;LSHIFT        CP #59:JR Z,K2;RSHIFT        CP #11:JR Z,K9;ALT        CP #0D:JR Z,K0;TAB        CP #58:JR Z,K1;CAPS        CP #14:JR Z,K3;CTRL        CP #0D:JR C,K4        CP #76:JR Z,K4;ESC        CP #78:JR Z,K4;F11        CP #83:JR Z,K4;F7        CP #75:JR Z,K5;U        CP #6B:JR Z,K6;L        CP #72:JR Z,K7;D        CP #74:JR Z,K8;R        CP #7D:JR Z,KA;PGup        CP #7A:JR Z,KC;PGdn        CP #77:JR Z,KB;NUML        JP ALM;-------K0      LD HL,TAB+0:JR KFFK1      LD HL,TAB+1:JR KFFK2      LD HL,TAB+2:JR KFFK3      LD HL,TAB+3:JR KFFK4      LD HL,TAB+4:JR KFFK5      LD HL,TAB+5:JR KFFK6      LD HL,TAB+6:JR KFFK7      LD HL,TAB+7:JR KFFK8      LD HL,TAB+8:JR KFFKA      LD HL,TAB+10:JR KFFKB      LD HL,TAB+11:JR KFFKC      LD HL,TAB+12;-------KFF     CP (HL):RET Z        LD (HL),A        LD (ARK),A        LD (IX+23),#FF        RET;-------KOF     IN A;                   BC=#BFF7        OR A:JR Z,EBUKoF     LD C,A        LD A,#CA,(BAT),A        LD A,(E0F):OR A:LD (IX+25),0        LD A,C:JR Z,NOE0        CP #12:RET Z        CP #59:RET ZNOE0    LD HL,TAB,BC,20        CPIR:RET NZ:DEC HL        LD (HL),0        RETEBU     LD A,#C3,(BAT),A:RET;-------TAB     DS 1;  +0  TAB        DS 1;  +1  CASP LOCK        DS 1;  +2  SHIFT        DS 1;  +3  CTRL        DS 1;  +4  F1-F12        DS 4;  +5  CURSOR KEYZ        DS 4;  +9  ALT,pgUP,NUML,pgDN        DS 7;  +13 oth KEYZ        DB #FF        NOP ;+21 NXF        NOP ;+22 WINARR     NOP ;+23 ARARK     NOP ;+24 LST KEYE0F     NOP ;+25 E0 Prefx;-------TAI0    DB "@0E161E26252E363D3E46454E55"        DB "@151D242D2C353C43444D545B5D"        DB "@1C1B232B34333B424B4C52"        DB "@1A22212A32313A41494A29"        DB "@797B7C";-------TAIE1   DB #27,"1234567890-="        DB "qwertyuiop[]\"        DB "asdfghjkl;'"        DB "zxcvbnm,./ +-*"TAIE2   DB #7E,"!@#$%^&*()_+"        DB "QWERTYUIOP{}|"        DB "ASDFGHJKL:",#22        DB "ZXCVBNM<>? +-*"TAIE0   DB 0,1,2,3,4,5,6,7,8,9,10,11,12        DB 23,24,25,35,36,44,45,46,#FFTAIR0   DB 1,2,3,4,5,6,7,8,9,10,11,12        DB 25,46,#FFTAIR1   DB #F1,"1234567890-="        DB "©Ê„™•≠£ËÈßÂÍ\"        DB "‰Î¢†Ø‡Æ´§¶Ì"        DB "ÔÁ·¨®‚Ï°Ó. +-*"TAIR2   DB #F0,"@2122FB3B","%:?*()_+"        DB "âñìäÖçÉòôáïö/"        DB "îõÇÄèêéãÑÜù"        DB "üóëåàíúÅû, +-*";-------ISINF   DB #09,#0EISIL    DB "ENG"        DB #2FISII    DB "INS"        DB #0B,1,"CAPS:"ISIC    DB "OFF"        DB 0ISI1    DB "ENG"ISI2    DB "RUS"ISI3    DB "INS"ISI4    DB "OVR"ISI5    DB "OFF"ISI6    DB "ON ";-------CLTT    NOP ;TEMPCLST    NOP ;0-LOW, 1-HILANG    NOP ;0-ENG, 1-RUSINOV    NOP ;0-INSERT, 1-OVERIWAD    DS 2IWOF    DS 2IBSZ    DS 2ISAD    DS 2ICUP    NOP ;\        NOP ;/IISP    DS 2;-------BCA     EQU TAB+1BCS     EQU TAB+2BSS     EQU TAB+3BFS     EQU TAB+4BUP     EQU TAB+5BLF     EQU TAB+6BDN     EQU TAB+7BRG     EQU TAB+8BHM     EQU TAB+9BPU     EQU TAB+10BED     EQU TAB+11BPD     EQU TAB+12BAL     EQU TAB+13;---------------------------------------