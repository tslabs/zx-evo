# Управление памятью

TS конфигурация позволяет адресовать до 4096Кб RAM и 512Кб ROM. Процессору вся эта память проецируется в виде 64Кб, разделенных на 4 окна по 16Кб. Для управления содержимым каждого окна предусмотрен свой 8 битный регист.

Номер окна|Диапазон памяти|Регистр управления окном|R/W|Init
----------|---------------|------------------------|---|----
0         |$0000-$3FFF    |Page0                   | W |$00
1         |$4000-$7FFF    |Page1                   | W |$05
2         |$8000-$BFFF    |Page2                   |R/W|$02
3         |$C000-$FFFF    |Page3                   |R/W|$00

Память компьютера разбивается на страницы по 16Кб, таким образом становится доступно до 256 страниц RAM и 32 страниц ROM. Для выбора конкретной страницы в любом окне, необходимо лишь записать номер этой страницы в соответствующий регистр.

В окнах 1, 2, 3 отображаются только страницы RAM. В окне 0 можно отображать страницы RAM или ROM, в зависимости от бита *W0_RAM* регистра **MemConfig** (0 - отображается ROM, 1 - отображается RAM). При этом для выбора страницы ROM используются только биты 4:0 регистра **Page0**.

##### Регистр MemConfig
	Биты   7    6    5    4    3       2      1     0
	     LCK128[1:0] -    -  W0_RAM !W0_MAP W0_WE ROM128
	R/W    W    W              W       W      W     W
	Init   0    0    x    x    0       1      0     0

* Биты 7:6 - выбор режима ограничений порта $7FFD,
* Биты 5:4 - зарезервированы,
* Бит 3 - выбор ROM/RAM,
* Бит 2 - отключение маппинга,
* Бит 1 - разрешение записи в ROM/RAM,
* Бит 0 - выбор страниц маппинга.

С помощью бита *W0_WE* регистра **MemConfig** можно запретить (значение 0) или разрешить (значение 1) запись в окно 0. Для страниц RAM - это просто запрет записи данных. Для ROM запись будет производится на флеш память.

# Управление портом $7FFD <a name="7ffd"></a>

Порт $7FFD работает аналогично стандартному Spectrum. Помимо этого можно настроить режим работы данного порта. Режим задается битами *LCK128*[1:0] регистра **MemConfig**:

LCK128[1:0]|Режим порта $7FFD| Подстановка бит в регистр Page3
-----------|-----------------|--------------------------------------
00         | 512Кб           | Page3[4:0] = $7FFD[7:6], $7FFD[2:0]
01         | 128Кб           | Page3[2:0] = $7FFD[2:0]
10         | Авто            | -
11         | 1024Кб          | Page3[5:0] = $7FFD[5], $7FFD[7:6], $7FFD[2:0]

При записи значений в порт $7FFD в режимах 128Кб, 512Кб и 1024Кб, биты, отвечающие за переключение страниц, записываются в младшие разряды регистра **Page3**.

Режим *Авто* позволяет с помощью длинной адресации порта работать с 512Кб RAM (`out (c),a`), а через короткую адресацию с 128Кб RAM (`out ($FD),a`). Режим адресации определяется по опкоду команды..

##### Порт $7FFD

	Биты   7    6    5    4      3    2  1  0
	     R512[7:6] LOCK ROM128 VPAGE R128[2:0]
	R/W    W    W    W    W      W    W  W  W
	Init   0    0    0    0      0    0  0  0
* Биты 7:6 - биты 4:3 регистра **Page3** для режима 512Кб,
* Бит 5 - бит 5 регистра **Page3** для режима 1024Кб или бит защелки порта,
* Бит 4 - аналог бита *ROM128* регистра **MemConfig**,
* Бит 3 - выбор видео страницы экрана Spectrum,
* Биты 2:0 - биты 2:0 регистра **Page3**.

При записи единицы в 5 бит (защелка) порта $7FFD в любом из режимов кроме 1024Кб происходит отключение порта $7FFD. После RESET порт снова доступен для записи.

# Маппинг страниц в окне 0 <a name="mapping"></a>

В нулевом окне можно отображать страницы RAM/ROM в двух режимах:

* Режим маппинга страниц
* Обычный режим

Режим выбирается с помощью бита *!W0_MAP* регистра **MemConfig**: 0 - режим маппинга страниц, 1 - обычный режим. 

В обычном режиме номер проецируемой страницы берется из регистра **Page0**[7:0] для RAM и **Page0**[4:0] для ROM.

Режим маппинга страниц используется для подключения 64кб прошивок ПЗУ, которые могут располагаться как в ROM, так и в RAM компьютера. Выбор страницы этого ПЗУ происходит с помощью сигнала DOS и бита *ROM128* регистра **MemConfig** (или порта $7FFD). Сигнал DOS и бит *ROM128* подставляются в качестве 1 и 0 бита номера страницы соответственно, а все остальные биты берутся из регистра **Page0**, таким образом прошивки ПЗУ должны располагаться в страницах кратных 4.

Формат прошивок ПЗУ и управляющие сигналы для выбора страниц этого ПЗУ представлены в следующей таблице:

DOS|ROM128|Страницы ПЗУ
---|------|------------
0  | 0    |Service
0  | 1    |DOS
1  | 0    |128
1  | 1    |48
